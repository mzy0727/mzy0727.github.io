<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="keywords" content="Hexo Theme Keep">
    <meta name="description" content="mzy的成长历程">
    <meta name="author" content="Mzy">
    
    <title>
        
            从零实现WebServer之HTTP请求类 |
        
        Mzy&#39;s Blog
    </title>
    
<link rel="stylesheet" href="/css/style.css">

    
        <link rel="shortcut icon" href="/images/author.svg">
    
    <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/hexo-theme-keep@4.0.5/source/font/css/fontawesome.min.css">
    <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/hexo-theme-keep@4.0.5/source/font/css/regular.min.css">
    <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/hexo-theme-keep@4.0.5/source/font/css/solid.min.css">
    <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/hexo-theme-keep@4.0.5/source/font/css/brands.min.css">
    
    <script class="keep-theme-configurations">
    const KEEP = window.KEEP || {}
    KEEP.hexo_config = {"hostname":"dybil.top","root":"/","language":"zh-CN","path":"search.json"}
    KEEP.theme_config = {"base_info":{"primary_color":"#00CC33","title":"Mzy's Blog","author":"Mzy","avatar":"/images/author.svg","logo":"/images/author.svg","favicon":"/images/author.svg"},"menu":{"Archives":"/archives","Tags":"/tags","Categories":"/categories","Links":"/links","About":"/about","Photos":"/photos"},"first_screen":{"enable":true,"background_img":"/images/bg.svg","background_img_dark":"/images/bg.svg","description":"Keep writing and Keep loving.","hitokoto":true},"social_contact":{"enable":true,"links":{"github":"https://dybil.top","weixin":"https://dybil.top","qq":"https://dybil.top","weibo":"https://dybil.top","zhihu":"https://dybil.top","twitter":"https://dybil.top","facebook":"https://dybil.top","email":"https://dybil.top"}},"scroll":{"progress_bar":true,"percent":true,"hide_header":true},"home":{"category":true,"tag":true,"announcement":null},"post":{"author_badge":{"enable":true,"level_badge":false,"custom_badge":["炼气","筑基","结丹","元婴","化神"]},"word_count":{"wordcount":true,"min2read":true},"datetime_format":"YYYY-MM-DD HH:mm:ss","copyright_info":true,"share":true,"reward":{"enable":true,"img_link":null,"text":null}},"code_block":{"tools":{"enable":true,"style":"default"},"highlight_theme":"default"},"toc":{"enable":true,"number":true,"expand_all":false,"init_open":true,"layout":"right"},"website_count":{"busuanzi_count":{"enable":true,"site_uv":true,"site_pv":false,"page_pv":true}},"local_search":{"enable":true,"preload":true},"comment":{"enable":true,"use":"waline","valine":{"appid":null,"appkey":null,"server_urls":null,"placeholder":null},"gitalk":{"github_id":null,"github_admins":null,"repository":null,"client_id":null,"client_secret":null,"proxy":null},"twikoo":{"env_id":null,"region":null,"version":"1.6.21"},"waline":{"server_url":"https://waline-test-liart.vercel.app","reaction":true,"version":2},"giscus":{"repo":null,"repo_id":null,"category":"Announcements","category_id":null,"reactions_enabled":false},"artalk":{"server":null},"disqus":{"shortname":null}},"rss":{"enable":false},"lazyload":{"enable":false},"cdn":{"enable":true,"provider":"jsdelivr"},"pjax":{"enable":true},"footer":{"since":2022,"word_count":true,"icp":{"enable":false,"record_code":null,"url":"https://beian.miit.gov.cn"},"site_deploy":{"enable":true,"provider":"github","url":null},"shields_style":{"enable":false,"custom":[{"link_url":null,"img_url":null}]}},"inject":{"enable":false,"css":[null],"js":[null]},"root":"","version":"4.0.5"}
    KEEP.language_ago = {"second":"%s 秒前","minute":"%s 分钟前","hour":"%s 小时前","day":"%s 天前","week":"%s 周前","month":"%s 个月前","year":"%s 年前"}
    KEEP.language_code_block = {"copy":"复制代码","copied":"已复制","fold":"折叠代码块","folded":"已折叠"}
    KEEP.language_copy_copyright = {"copy":"复制版权信息","copied":"已复制","title":"原文标题","author":"原文作者","link":"原文链接"}
  </script>
<meta name="generator" content="Hexo 6.3.0"></head>


<body>
<div class="progress-bar-container">
    
        <span class="scroll-progress-bar"></span>
    

    
        <span class="pjax-progress-bar"></span>
        <i class="pjax-progress-icon fas fa-circle-notch fa-spin"></i>
    
</div>


<main class="page-container border-box">

    <!-- home first screen  -->
    

    <!-- page content -->
    <div class="page-main-content border-box">
        <div class="page-main-content-top">
            
<header class="header-wrapper">

    <div class="border-box header-content">
        <div class="left border-box">
            
                <a class="logo-image border-box" href="/">
                    <img src="/images/author.svg">
                </a>
            
            <a class="site-name border-box" href="/">
               Mzy&#39;s Blog
            </a>
        </div>

        <div class="right border-box">
            <div class="pc">
                <ul class="menu-list">
                    <li class="menu-item">
                        <a class=""
                           href="/"
                        >首页</a>
                    </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/archives"
                            >归档</a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/tags"
                            >标签</a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/categories"
                            >分类</a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/links"
                            >友链</a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/about"
                            >关于</a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/photos"
                            >相册</a>
                        </li>
                    
                    
                        <li class="menu-item search search-popup-trigger">
                            <i class="fas search fa-search"></i>
                        </li>
                    
                </ul>
            </div>
            <div class="mobile">
                
                    <div class="icon-item search search-popup-trigger"><i class="fas fa-search"></i></div>
                
                <div class="icon-item menu-bar">
                    <div class="menu-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="header-drawer">
        <ul class="drawer-menu-list">
            <li class="drawer-menu-item flex-center">
                <a class=""
                   href="/"
                >首页</a>
            </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/archives"
                    >归档</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/tags"
                    >标签</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/categories"
                    >分类</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/links"
                    >友链</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/about"
                    >关于</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/photos"
                    >相册</a>
                </li>
            
        </ul>
    </div>

    <div class="window-mask"></div>

</header>


        </div>

        <div class="page-main-content-middle border-box">

            <div class="main-content border-box">
                

                    
<div class="fade-in-down-animation">
    <div class="post-page-container border-box">
        <div class="post-content-container border-box">
            
                <div class="post-content-top border-box"
                     style="height: 13.8rem"
                >
                    <div class="cover-post-title">
                        从零实现WebServer之HTTP请求类
                    </div>
                    <img class="post-cover" src="/images/post_banner.jpg"
                         onerror="this.style.display='none'"
                    >
                </div>
            

            <div class="post-content-bottom border-box has-cover">
                

                
                    <div class="post-header border-box">
                        
                            <div class="avatar-box border-box">
                                <img src="/images/author.svg">
                            </div>
                        
                        <div class="info-box">
                            <div class="author border-box">
                                <span class="name">Mzy</span>
                                
                                    <span class="author-badge">元婴</span>
                                
                            </div>
                            <div class="meta-info border-box">
                                

<div class="post-meta-info-container border-box post">
    <div class="post-meta-info border-box">
        

        
            <span class="meta-info-item post-create-date">
                <i class="icon fa-solid fa-calendar-check"></i>&nbsp;
                <span class="pc">2024-01-05 13:55:53</span>
                <span class="mobile">2024-01-05 13:55</span>
            </span>

            <span class="meta-info-item post-update-date">
                <i class="icon fa-solid fa-file-pen"></i>&nbsp;
                <span class="pc" data-updated="Fri Jan 05 2024 13:57:16 GMT+0800">2024-01-05 13:57:16</span>
            </span>
        

        
            <span class="meta-info-item post-category border-box"><i class="icon fas fa-folder"></i>&nbsp;
                <ul class="post-category-ul">
                    
                            <li class="category-item"><a href="/categories/%E7%AC%94%E8%AE%B0/">笔记</a></li>
                        
                    
                </ul>
            </span>
        

        
            <span class="post-tag meta-info-item border-box">
                <i class="icon fas fa-tags"></i>&nbsp;
                <ul class="post-tag-ul">
                    
                            <li class="tag-item"><span class="tag-separator"><i class="icon fas fa-hashtag"></i></span><a href="/tags/c/">c++</a></li>
                        
                    
                            <li class="tag-item"><span class="tag-separator"><i class="icon fas fa-hashtag"></i></span><a href="/tags/WebServer/">WebServer</a></li>
                        
                    
                </ul>
            </span>
        

        
        
            <span class="meta-info-item post-wordcount">
                <i class="icon fas fa-file-word"></i>&nbsp;<span>12k 字</span>
            </span>
        
        
            <span class="meta-info-item post-min2read">
                <i class="icon fas fa-clock"></i>&nbsp;<span>50 分钟</span>
            </span>
        
        
            <span class="meta-info-item post-pv">
                <i class="icon fas fa-eye"></i>&nbsp;<span id="busuanzi_value_page_pv"></span>
            </span>
        
    </div>

    
</div>

                            </div>
                        </div>
                    </div>
                

                <div class="post-content keep-markdown-body">
                    

                    <h1 id="从零实现WebServer之HTTP请求类"><a href="#从零实现WebServer之HTTP请求类" class="headerlink" title="从零实现WebServer之HTTP请求类"></a>从零实现WebServer之HTTP请求类</h1><h2 id="http请求类"><a href="#http请求类" class="headerlink" title="http请求类"></a>http请求类</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">http_conn</span>&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">// 文件名称长度</span></span><br><span class="line">    <span class="type">static</span> <span class="type">const</span> <span class="type">int</span> FILENAME_LEN = <span class="number">200</span>;</span><br><span class="line">    <span class="comment">// 读缓冲大小</span></span><br><span class="line">    <span class="type">static</span> <span class="type">const</span> <span class="type">int</span> READ_BUFFER_SIZE = <span class="number">2048</span>;</span><br><span class="line">    <span class="comment">// 写缓冲大小</span></span><br><span class="line">    <span class="type">static</span> <span class="type">const</span> <span class="type">int</span> WRITE_BUFFER_SIZE = <span class="number">1024</span>;</span><br><span class="line">    <span class="comment">// 请求方法</span></span><br><span class="line">    <span class="keyword">enum</span> <span class="title class_">METHOD</span>&#123;</span><br><span class="line">        GET = <span class="number">0</span>, POST, HEAD, PUT, DELETE, TRACE, OPTIONS, CONNECT, PATH</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">// 主状态机状态</span></span><br><span class="line">    <span class="keyword">enum</span> <span class="title class_">CHECK_STATE</span>&#123;</span><br><span class="line">        CHECK_STATE_REQUESTLINE = <span class="number">0</span>,</span><br><span class="line">        CHECK_STATE_HEADER,</span><br><span class="line">        CHECK_STATE_CONTENT</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">// 报文解析结果</span></span><br><span class="line">    <span class="keyword">enum</span> <span class="title class_">HTTP_CODE</span>&#123;</span><br><span class="line">        NO_REQUEST = <span class="number">0</span>, GET_REQUEST, BAD_REQUEST, NO_RESOURCE, FORBIDDEN_REQUEST, FILE_REQUEST, INTERNAL_ERROR, CLOSED_CONNECTION</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">// 从状态机状态</span></span><br><span class="line">    <span class="keyword">enum</span> <span class="title class_">LINE_STATUS</span>&#123;</span><br><span class="line">        LINE_OK = <span class="number">0</span>, LINE_BAD, LINE_OPEN</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">http_conn</span>()&#123;&#125;</span><br><span class="line">    ~<span class="built_in">http_conn</span>()&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">// 初始化连接</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">init</span><span class="params">(<span class="type">int</span> sockfd, <span class="type">const</span> sockaddr_in &amp;addr, <span class="type">const</span> <span class="type">char</span> *, <span class="type">int</span>, <span class="type">int</span>, string user, string passwd, string sqlname)</span></span>;</span><br><span class="line">    <span class="comment">// 关闭连接</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">close_conn</span><span class="params">(<span class="type">bool</span> real_close=<span class="literal">true</span>)</span></span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">process</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="comment">// 读取客户端全部数据</span></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">read_once</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="comment">// 写响应报文</span></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">write</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function">sockaddr_in* <span class="title">get_address</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> &amp;m_address;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 初始化数据库读取表</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">initmysql_result</span><span class="params">(connection_pool *connPool)</span></span>;</span><br><span class="line">    <span class="type">int</span> timer_flag;     <span class="comment">// reactor是否处理数据</span></span><br><span class="line">    <span class="type">int</span> improv;         <span class="comment">// reactor是否处理失败</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">init</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="comment">// 从m_read_buf读取，处理请求报文</span></span><br><span class="line">    <span class="function">HTTP_CODE <span class="title">process_read</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="comment">// 向m_write_buf写入响应报文</span></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">process_write</span><span class="params">(HTTP_CODE ret)</span></span>;</span><br><span class="line">    <span class="comment">// 主状态机解析请求行数据</span></span><br><span class="line">    <span class="function">HTTP_CODE <span class="title">parse_request_line</span><span class="params">(<span class="type">char</span> *text)</span></span>;</span><br><span class="line">    <span class="comment">// 主状态机解析请求头数据</span></span><br><span class="line">    <span class="function">HTTP_CODE <span class="title">parse_headers</span><span class="params">(<span class="type">char</span> *text)</span></span>;</span><br><span class="line">    <span class="comment">// 主状态机解析请求内容</span></span><br><span class="line">    <span class="function">HTTP_CODE <span class="title">parse_content</span><span class="params">(<span class="type">char</span> *text)</span></span>;</span><br><span class="line">    <span class="comment">// 生成响应报文</span></span><br><span class="line">    <span class="function">HTTP_CODE <span class="title">do_request</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="comment">// 获得未解读数据位置</span></span><br><span class="line">    <span class="comment">//m_start_line是行在buffer中的起始位置，将该位置后面的数据赋给text</span></span><br><span class="line">    <span class="comment">//此时从状态机已提前将一行的末尾字符\r\n变为\0\0，所以text可以直接取出完整的行进行解析</span></span><br><span class="line">    <span class="function"><span class="type">char</span>* <span class="title">get_line</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> m_read_buf + m_start_line;&#125;;</span><br><span class="line">    <span class="comment">// 从状态机读取一行</span></span><br><span class="line">    <span class="function">LINE_STATUS <span class="title">parse_line</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">unmap</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 生成具体响应报文</span></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">add_response</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *format, ...)</span></span>;</span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">add_content</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *content)</span></span>;</span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">add_status_line</span><span class="params">(<span class="type">int</span> status, <span class="type">const</span> <span class="type">char</span> *title)</span></span>;</span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">add_headers</span><span class="params">(<span class="type">int</span> content_length)</span></span>;</span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">add_content_type</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">add_content_length</span><span class="params">(<span class="type">int</span> content_length)</span></span>;</span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">add_linger</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">add_blank_line</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="type">static</span> <span class="type">int</span> m_epollfd;       <span class="comment">// epoll事件表</span></span><br><span class="line">    <span class="type">static</span> <span class="type">int</span> m_user_count;    <span class="comment">// 客户数量</span></span><br><span class="line">    MYSQL *mysql;               <span class="comment">// 数据库连接</span></span><br><span class="line">    <span class="type">int</span> m_state;                <span class="comment">// reactor区分读写任务，0读，1写</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="type">int</span> m_sockfd;               <span class="comment">// 客户socket</span></span><br><span class="line">    sockaddr_in m_address;      <span class="comment">// 客户地址</span></span><br><span class="line">    <span class="type">char</span> m_read_buf[READ_BUFFER_SIZE];</span><br><span class="line">    <span class="type">int</span> m_read_idx;             <span class="comment">// 已读数据结尾</span></span><br><span class="line">    <span class="type">int</span> m_checked_idx;          <span class="comment">// 解析进行处</span></span><br><span class="line">    <span class="type">int</span> m_start_line;           <span class="comment">// 解析开始处</span></span><br><span class="line">    <span class="type">char</span> m_write_buf[WRITE_BUFFER_SIZE];</span><br><span class="line">    <span class="type">int</span> m_write_idx;            <span class="comment">// 已写数据结尾</span></span><br><span class="line">    CHECK_STATE m_check_state;  <span class="comment">// 主状态机状态</span></span><br><span class="line">    METHOD m_method;            <span class="comment">// 请求方法</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 解析请求报文变量</span></span><br><span class="line">    <span class="type">char</span> m_real_file[FILENAME_LEN]; <span class="comment">// 实际文件路径</span></span><br><span class="line">    <span class="type">char</span> *m_url;</span><br><span class="line">    <span class="type">char</span> *m_version;</span><br><span class="line">    <span class="type">char</span> *m_host;</span><br><span class="line">    <span class="type">int</span> m_content_length;</span><br><span class="line">    <span class="type">bool</span> m_linger;          <span class="comment">// 是否为长连接</span></span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> *m_file_address;   <span class="comment">// 服务器上文件指针</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">stat</span> m_file_stat;<span class="comment">// 文件信息结构体</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">iovec</span> m_iv[<span class="number">2</span>];   <span class="comment">// 向量元素</span></span><br><span class="line">    <span class="type">int</span> m_iv_count;         <span class="comment">// 向量元素个数</span></span><br><span class="line">    <span class="type">int</span> cgi;                <span class="comment">// 是否启用POST</span></span><br><span class="line">    <span class="type">char</span> *m_string;</span><br><span class="line">    <span class="type">uint32_t</span> bytes_to_send;      <span class="comment">// 剩余发送字节</span></span><br><span class="line">    <span class="type">uint32_t</span> bytes_have_send;    <span class="comment">// 已发送字节</span></span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *doc_root;        <span class="comment">// 资源根目录</span></span><br><span class="line"></span><br><span class="line">    map&lt;string, string&gt; m_users;    <span class="comment">// 用户表</span></span><br><span class="line">    <span class="type">int</span> m_TRIGMode;         <span class="comment">// ET模式</span></span><br><span class="line">    <span class="type">int</span> m_close_log;        <span class="comment">// 是否关闭日志</span></span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> sql_user[<span class="number">100</span>];     <span class="comment">// 数据库用户名</span></span><br><span class="line">    <span class="type">char</span> sql_passwd[<span class="number">100</span>];   <span class="comment">// 数据库密码</span></span><br><span class="line">    <span class="type">char</span> sql_name[<span class="number">100</span>];     <span class="comment">// 数据库名</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<p>主要成员变量和枚举：</p>
<ul>
<li><code>FILENAME_LEN</code>：文件名长度常量，设为200。</li>
<li><code>READ_BUFFER_SIZE</code>：读缓冲大小常量，设为2048。</li>
<li><code>WRITE_BUFFER_SIZE</code>：写缓冲大小常量，设为1024。</li>
<li><code>METHOD</code>：枚举类型，表示HTTP请求方法，包括GET、POST等。</li>
<li><code>CHECK_STATE</code>：枚举类型，表示主状态机的三个可能状态：解析请求行、解析请求头、解析请求内容。</li>
<li><code>HTTP_CODE</code>：枚举类型，表示报文解析结果，包括无请求、GET请求、错误请求等。</li>
<li><code>LINE_STATUS</code>：枚举类型，表示从状态机的三个可能状态：行正常、行错误、行未完成。</li>
</ul>
<p>主要成员函数：</p>
<ul>
<li><code>init</code>：初始化连接。</li>
<li><code>close_conn</code>：关闭连接。</li>
<li><code>process</code>：处理HTTP请求。</li>
<li><code>read_once</code>：一次性读取客户端全部数据。</li>
<li><code>write</code>：写响应报文。</li>
<li><code>get_address</code>：获取客户端地址。</li>
<li><code>initmysql_result</code>：初始化数据库读取表。</li>
<li><code>parse_request_line</code>：解析请求行数据。</li>
<li><code>parse_headers</code>：解析请求头数据。</li>
<li><code>parse_content</code>：解析请求内容。</li>
<li><code>do_request</code>：生成响应报文。</li>
<li><code>get_line</code>：获得未解读数据位置。</li>
<li><code>parse_line</code>：从状态机读取一行。</li>
<li><code>unmap</code>：解除映射关系。</li>
<li><code>add_response</code>：生成具体响应报文。</li>
<li><code>add_content</code>：添加响应内容。</li>
<li><code>add_status_line</code>：添加响应状态行。</li>
<li><code>add_headers</code>：添加响应头。</li>
<li><code>add_content_type</code>：添加响应内容类型。</li>
<li><code>add_content_length</code>：添加响应内容长度。</li>
<li><code>add_linger</code>：添加连接状态。</li>
<li><code>add_blank_line</code>：添加空行。</li>
</ul>
<p>静态成员：</p>
<ul>
<li><code>m_epollfd</code>：epoll事件表。</li>
<li><code>m_user_count</code>：客户数量。</li>
</ul>
<h3 id="获取用户表数据-initmysql-result"><a href="#获取用户表数据-initmysql-result" class="headerlink" title="获取用户表数据 initmysql_result"></a>获取用户表数据 initmysql_result</h3><p>这段代码是在初始化阶段从MySQL数据库中获取用户表数据，并将用户名和密码存储在内存中的<code>map&lt;string, string&gt; users</code>中。同时，使用了<code>mutexlocker</code>进行表的互斥锁操作，确保在多线程环境下对用户表的访问是安全的。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">mutexlocker m_lock;         <span class="comment">// 表互斥锁</span></span><br><span class="line">map&lt;string, string&gt; users;  <span class="comment">// 内存用户表</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">http_conn::initmysql_result</span><span class="params">(connection_pool *connPool)</span></span>&#123;</span><br><span class="line">    <span class="comment">// 从数据库连接池取一个连接</span></span><br><span class="line">    MYSQL *mysql = <span class="literal">nullptr</span>;</span><br><span class="line">    <span class="function">connectionRAII <span class="title">mysqlcon</span><span class="params">(&amp;mysql, connPool)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 在user表中检索</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">mysql_query</span>(mysql, <span class="string">&quot;SELECT username, password FROM user&quot;</span>))&#123;</span><br><span class="line">        <span class="built_in">LOG_ERROR</span>(<span class="string">&quot;SELECT error:%s\n&quot;</span>, <span class="built_in">mysql_error</span>(mysql));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 从表中检索完整的结果集</span></span><br><span class="line">    MYSQL_RES *result = <span class="built_in">mysql_store_result</span>(mysql);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 结果集的列数</span></span><br><span class="line">    <span class="comment">// int num_fields = mysql_num_fields(result);</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 所有字段结构的数组</span></span><br><span class="line">    <span class="comment">// MYSQL_FIELD *fields = mysql_fetch_field(result);</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将用户名和密码存入map中</span></span><br><span class="line">    <span class="keyword">while</span>(MYSQL_ROW row = <span class="built_in">mysql_fetch_row</span>(result))&#123;</span><br><span class="line">        <span class="function">string <span class="title">temp1</span><span class="params">(row[<span class="number">0</span>])</span></span>;</span><br><span class="line">        <span class="function">string <span class="title">temp2</span><span class="params">(row[<span class="number">1</span>])</span></span>;</span><br><span class="line">        users[temp1] = temp2;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;mutexlocker m_lock;         <span class="comment">// 表互斥锁</span></span><br><span class="line">map&lt;string, string&gt; users;  <span class="comment">// 内存用户表</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">http_conn::initmysql_result</span><span class="params">(connection_pool *connPool)</span></span>&#123;</span><br><span class="line">    <span class="comment">// 从数据库连接池取一个连接</span></span><br><span class="line">    MYSQL *mysql = <span class="literal">nullptr</span>;</span><br><span class="line">    <span class="function">connectionRAII <span class="title">mysqlcon</span><span class="params">(&amp;mysql, connPool)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 在user表中检索</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">mysql_query</span>(mysql, <span class="string">&quot;SELECT username, password FROM user&quot;</span>))&#123;</span><br><span class="line">        <span class="built_in">LOG_ERROR</span>(<span class="string">&quot;SELECT error:%s\n&quot;</span>, <span class="built_in">mysql_error</span>(mysql));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 从表中检索完整的结果集</span></span><br><span class="line">    MYSQL_RES *result = <span class="built_in">mysql_store_result</span>(mysql);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 结果集的列数</span></span><br><span class="line">    <span class="comment">// int num_fields = mysql_num_fields(result);</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 所有字段结构的数组</span></span><br><span class="line">    <span class="comment">// MYSQL_FIELD *fields = mysql_fetch_field(result);</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将用户名和密码存入map中</span></span><br><span class="line">    <span class="keyword">while</span>(MYSQL_ROW row = <span class="built_in">mysql_fetch_row</span>(result))&#123;</span><br><span class="line">        <span class="function">string <span class="title">temp1</span><span class="params">(row[<span class="number">0</span>])</span></span>;</span><br><span class="line">        <span class="function">string <span class="title">temp2</span><span class="params">(row[<span class="number">1</span>])</span></span>;</span><br><span class="line">        users[temp1] = temp2;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li><code>mutexlocker m_lock;</code>：定义了一个名为<code>m_lock</code>的<code>mutexlocker</code>对象，用于在多线程环境中对用户表进行互斥操作。</li>
<li><code>map&lt;string, string&gt; users;</code>：定义了一个名为<code>users</code>的<code>map</code>，用于存储从数据库中读取的用户名和密码。</li>
<li><code>void http_conn::initmysql_result(connection_pool *connPool)</code>：这是<code>http_conn</code>类的成员函数，用于从MySQL数据库中获取用户表数据。<ul>
<li><code>connectionRAII mysqlcon(&amp;mysql, connPool);</code>：创建了一个<code>connectionRAII</code>对象，通过该对象获取了一个数据库连接。</li>
<li><code>if(mysql_query(mysql, &quot;SELECT username, password FROM user&quot;))</code>：执行了一个SQL查询语句，从<code>user</code>表中选择用户名和密码。</li>
<li><code>MYSQL_RES *result = mysql_store_result(mysql);</code>：将查询结果存储在<code>result</code>中。</li>
<li><code>while(MYSQL_ROW row = mysql_fetch_row(result))</code>：遍历查询结果的每一行，将用户名和密码存入<code>map&lt;string, string&gt; users</code>中。</li>
</ul>
</li>
</ol>
<p>在这个过程中，由于涉及到对共享数据的读写操作，使用了互斥锁来确保线程安全。这是因为在多线程环境中，多个线程可能同时访问和修改<code>users</code>表，为了防止数据不一致和竞争条件，使用互斥锁是一种常见的做法。</p>
<h3 id="设置非阻塞-setnonblocking"><a href="#设置非阻塞-setnonblocking" class="headerlink" title="设置非阻塞 setnonblocking"></a>设置非阻塞 setnonblocking</h3><p>这段代码定义了一个函数<code>setnonblocking</code>，用于将给定的文件描述符设置为非阻塞模式。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 对文件描述符设置非阻塞</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">setnonblocking</span><span class="params">(<span class="type">int</span> fd)</span></span>&#123;</span><br><span class="line">    <span class="type">int</span> old_option = <span class="built_in">fcntl</span>(fd, F_GETFL);</span><br><span class="line">    <span class="type">int</span> new_option = old_option | O_NONBLOCK;</span><br><span class="line">    <span class="built_in">fcntl</span>(fd, F_SETFL, new_option);</span><br><span class="line">    <span class="keyword">return</span> old_option;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li><code>int setnonblocking(int fd)</code>：这是一个函数，接受一个文件描述符<code>fd</code>作为参数，返回一个整数值。</li>
<li><code>int old_option = fcntl(fd, F_GETFL);</code>：使用<code>fcntl</code>系统调用获取当前文件描述符<code>fd</code>的文件状态标志。</li>
<li><code>int new_option = old_option | O_NONBLOCK;</code>：将<code>O_NONBLOCK</code>标志与原有的文件状态标志进行按位或操作，设置文件描述符为非阻塞模式。</li>
<li><code>fcntl(fd, F_SETFL, new_option);</code>：使用<code>fcntl</code>系统调用将新的文件状态标志设置回文件描述符，使文件描述符变为非阻塞模式。</li>
<li><code>return old_option;</code>：返回原有的文件状态标志，方便之后需要的情况下恢复文件描述符的状态。</li>
</ol>
<p>这种设置非阻塞模式的操作通常用于套接字和其他I&#x2F;O操作，以便在进行读写时不会被阻塞，能够更好地适应异步I&#x2F;O的编程模型。</p>
<h3 id="注册读事件-addfd"><a href="#注册读事件-addfd" class="headerlink" title="注册读事件 addfd"></a>注册读事件 addfd</h3><p>这段代码定义了一个函数<code>addfd</code>，用于向内核事件表注册文件描述符的读事件。在ET（边缘触发）模式下，可以选择开启EPOLLONESHOT标志，表示这个文件描述符只能被一个线程处理一次。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 将内核事件表注册读事件，ET模式，选择开启EPOLLONESHOT</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">addfd</span><span class="params">(<span class="type">int</span> epollfd, <span class="type">int</span> fd, <span class="type">bool</span> one_shot, <span class="type">int</span> TRIGMode)</span></span>&#123;</span><br><span class="line">    epoll_event event;</span><br><span class="line">    event.data.fd = fd;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(TRIGMode == <span class="number">1</span>)</span><br><span class="line">        <span class="comment">// 读事件、ET模式、对方断开连接</span></span><br><span class="line">        event.events = EPOLLIN | EPOLLET | EPOLLRDHUP;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        event.events = EPOLLIN | EPOLLRDHUP;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(one_shot)</span><br><span class="line">        event.events |= EPOLLONESHOT;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 注册事件</span></span><br><span class="line">    <span class="built_in">epoll_ctl</span>(epollfd, EPOLL_CTL_ADD, fd, &amp;event);</span><br><span class="line">    <span class="built_in">setnonblocking</span>(fd);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li><p><code>void addfd(int epollfd, int fd, bool one_shot, int TRIGMode)</code>：这是一个函数，接受四个参数，分别是<code>epollfd</code>（内核事件表的文件描述符）、<code>fd</code>（要注册的文件描述符）、<code>one_shot</code>（是否开启EPOLLONESHOT标志）、<code>TRIGMode</code>（触发模式，这里使用了一个<code>TRIGMode</code>参数，值为1表示使用ET模式）。</p>
</li>
<li><p><code>epoll_event event;</code>：创建一个<code>epoll_event</code>结构体对象，用于描述事件。</p>
</li>
<li><p><code>event.data.fd = fd;</code>：设置<code>event</code>结构体中的文件描述符字段。</p>
</li>
<li><p><code>if(TRIGMode == 1)</code>：判断是否使用ET模式，如果是，设置事件为EPOLLIN（可读事件）、EPOLLET（边缘触发）、EPOLLRDHUP（对方断开连接）。</p>
<p>如果不是ET模式，仅设置事件为EPOLLIN和EPOLLRDHUP。</p>
</li>
<li><p><code>if(one_shot)</code>：判断是否开启EPOLLONESHOT标志，如果是，将<code>event</code>结构体中的事件字段加上EPOLLONESHOT。</p>
</li>
<li><p><code>epoll_ctl(epollfd, EPOLL_CTL_ADD, fd, &amp;event);</code>：将文件描述符<code>fd</code>添加到内核事件表中，并指定对应的事件。</p>
</li>
<li><p><code>setnonblocking(fd);</code>：调用之前定义的<code>setnonblocking</code>函数，将文件描述符设置为非阻塞模式。</p>
</li>
</ol>
<p>这个函数的目的是将文件描述符注册到内核事件表中，以便后续可以通过epoll来监听这个文件描述符的事件。在ET模式下，EPOLLONESHOT标志的使用表明了一次触发的事件只会被一个线程处理一次，需要重新注册。</p>
<h3 id="删除描述符-removefd"><a href="#删除描述符-removefd" class="headerlink" title="删除描述符 removefd"></a>删除描述符 removefd</h3><p>这段代码定义了一个函数<code>removefd</code>，用于从内核事件表中删除文件描述符，并关闭该文件描述符。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 从内核事件表删除描述符，关闭描述符</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">removefd</span><span class="params">(<span class="type">int</span> epollfd, <span class="type">int</span> fd)</span></span>&#123;</span><br><span class="line">    <span class="built_in">epoll_ctl</span>(epollfd, EPOLL_CTL_DEL, fd, <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">close</span>(fd);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li><code>void removefd(int epollfd, int fd)</code>：这是一个函数，接受两个参数，分别是<code>epollfd</code>（内核事件表的文件描述符）和<code>fd</code>（要删除的文件描述符）。</li>
<li><code>epoll_ctl(epollfd, EPOLL_CTL_DEL, fd, 0);</code>：调用<code>epoll_ctl</code>系统调用，从内核事件表中删除文件描述符<code>fd</code>。</li>
<li><code>close(fd);</code>：关闭文件描述符，释放相应的资源。</li>
</ol>
<p>这个函数的目的是在某些情况下，例如文件描述符对应的连接已经关闭，需要从内核事件表中移除该文件描述符，并释放相关资源，以防止不必要的事件触发。</p>
<h3 id="重置-modfd"><a href="#重置-modfd" class="headerlink" title="重置 modfd"></a>重置 modfd</h3><p>这段代码定义了一个函数<code>modfd</code>，用于修改已注册在内核事件表中的文件描述符的事件，将其重置为<code>EPOLLONESHOT</code>。这个操作通常在使用边缘触发（ET）模式时，表示一次事件只触发一次，需要重新注册。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 将事件重置为EPOLLONESHOT</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">modfd</span><span class="params">(<span class="type">int</span> epollfd, <span class="type">int</span> fd, <span class="type">int</span> ev, <span class="type">int</span> TRIGMode)</span></span>&#123;</span><br><span class="line">    epoll_event event;</span><br><span class="line">    event.data.fd = fd;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(TRIGMode == <span class="number">1</span>)</span><br><span class="line">        event.events = ev | EPOLLET | EPOLLONESHOT | EPOLLRDHUP;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        event.events = ev | EPOLLONESHOT | EPOLLRDHUP;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">epoll_ctl</span>(epollfd, EPOLL_CTL_MOD, fd, &amp;event);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li><p><code>void modfd(int epollfd, int fd, int ev, int TRIGMode)</code>：这是一个函数，接受四个参数，分别是<code>epollfd</code>（内核事件表的文件描述符）、<code>fd</code>（要修改的文件描述符）、<code>ev</code>（新的事件）、<code>TRIGMode</code>（触发模式，这里使用了一个<code>TRIGMode</code>参数，值为1表示使用ET模式）。</p>
</li>
<li><p><code>epoll_event event;</code>：创建一个<code>epoll_event</code>结构体对象，用于描述事件。</p>
</li>
<li><p><code>event.data.fd = fd;</code>：设置<code>event</code>结构体中的文件描述符字段。</p>
</li>
<li><p><code>if(TRIGMode == 1)</code>：判断是否使用ET模式，如果是，设置事件为传入的<code>ev</code>，并加上EPOLLET（边缘触发）、EPOLLONESHOT（一次触发一次）和EPOLLRDHUP（对方断开连接）标志。</p>
<p>如果不是ET模式，设置事件为传入的<code>ev</code>，并加上EPOLLONESHOT和EPOLLRDHUP标志。</p>
</li>
<li><p><code>epoll_ctl(epollfd, EPOLL_CTL_MOD, fd, &amp;event);</code>：调用<code>epoll_ctl</code>系统调用，将修改后的事件重新注册到内核事件表中。</p>
</li>
</ol>
<p>这个函数的目的是在某些情况下，例如需要重新监听的事件，将已注册的文件描述符重新设置为EPOLLONESHOT，以确保下一次事件触发时需要重新注册。</p>
<h3 id="关闭一个客户连接-close-conn"><a href="#关闭一个客户连接-close-conn" class="headerlink" title="关闭一个客户连接 close_conn"></a>关闭一个客户连接 close_conn</h3><p>这部分代码是<code>http_conn</code>类的成员函数<code>close_conn</code>的实现。主要功能是关闭一个客户连接，并在需要真正关闭时，从内核事件表中移除相应的文件描述符，同时更新类的静态成员<code>m_user_count</code>，表示当前的客户数量。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> http_conn::m_user_count = <span class="number">0</span>;</span><br><span class="line"><span class="type">int</span> http_conn::m_epollfd = <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 关闭一个客户连接</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">http_conn::close_conn</span><span class="params">(<span class="type">bool</span> real_close)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(real_close &amp;&amp; (m_sockfd != <span class="number">-1</span>))&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;close %d\n&quot;</span>, m_sockfd);</span><br><span class="line">        <span class="built_in">removefd</span>(m_epollfd, m_sockfd);</span><br><span class="line">        m_sockfd = <span class="number">-1</span>;</span><br><span class="line">        m_user_count--;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li><code>void http_conn::close_conn(bool real_close)</code>：这是一个成员函数，接受一个布尔参数<code>real_close</code>，表示是否真正关闭连接。</li>
<li><code>if(real_close &amp;&amp; (m_sockfd != -1))</code>：判断是否真正关闭连接，并且确保<code>m_sockfd</code>不为-1。如果条件成立，执行以下操作：<ul>
<li><code>printf(&quot;close %d\n&quot;, m_sockfd);</code>：打印关闭的客户端的文件描述符。</li>
<li><code>removefd(m_epollfd, m_sockfd);</code>：调用之前定义的<code>removefd</code>函数，从内核事件表中删除该文件描述符，同时关闭文件描述符。</li>
<li><code>m_sockfd = -1;</code>：将类的成员变量<code>m_sockfd</code>设置为-1，表示连接已关闭。</li>
<li><code>m_user_count--;</code>：减少静态成员<code>m_user_count</code>，表示当前的客户数量减少了一个。</li>
</ul>
</li>
</ol>
<p>这个函数的主要作用是关闭客户连接，释放相关资源，并更新当前客户数量。在一些情况下，可能需要保持文件描述符在内核事件表中注册，待后续操作。但在这里，采取了一次性关闭文件描述符并从内核事件表中移除的方式。</p>
<h3 id="初始化新接受的连接-init"><a href="#初始化新接受的连接-init" class="headerlink" title="初始化新接受的连接 init"></a>初始化新接受的连接 init</h3><p>这段代码是<code>http_conn</code>类的成员函数<code>init</code>的实现，用于初始化新接受的连接。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 初始化新接受的连接</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">http_conn::init</span><span class="params">()</span></span>&#123;</span><br><span class="line">    mysql = <span class="literal">nullptr</span>;</span><br><span class="line">    bytes_to_send = <span class="number">0</span>;</span><br><span class="line">    bytes_have_send = <span class="number">0</span>;</span><br><span class="line">    m_check_state = CHECK_STATE_REQUESTLINE;</span><br><span class="line">    m_linger = <span class="literal">false</span>;</span><br><span class="line">    m_method = GET;</span><br><span class="line">    m_url = <span class="number">0</span>;</span><br><span class="line">    m_version = <span class="number">0</span>;</span><br><span class="line">    m_host = <span class="number">0</span>;</span><br><span class="line">    m_start_line = <span class="number">0</span>;</span><br><span class="line">    m_checked_idx = <span class="number">0</span>;</span><br><span class="line">    m_read_idx = <span class="number">0</span>;</span><br><span class="line">    m_write_idx = <span class="number">0</span>;</span><br><span class="line">    cgi = <span class="number">0</span>;</span><br><span class="line">    m_state = <span class="number">0</span>;</span><br><span class="line">    timer_flag = <span class="number">0</span>;</span><br><span class="line">    improv = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(m_read_buf, <span class="number">0</span>, READ_BUFFER_SIZE);</span><br><span class="line">    <span class="built_in">memset</span>(m_write_buf, <span class="number">0</span>, WRITE_BUFFER_SIZE);</span><br><span class="line">    <span class="built_in">memset</span>(m_real_file, <span class="number">0</span>, FILENAME_LEN);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li><code>mysql = nullptr;</code>：将<code>mysql</code>指针设置为nullptr，表示暂时没有数据库连接。</li>
<li><code>bytes_to_send = 0;</code>：将<code>bytes_to_send</code>设置为0，表示待发送的字节数为0。</li>
<li><code>bytes_have_send = 0;</code>：将<code>bytes_have_send</code>设置为0，表示已发送的字节数为0。</li>
<li><code>m_check_state = CHECK_STATE_REQUESTLINE;</code>：将主状态机状态设置为<code>CHECK_STATE_REQUESTLINE</code>，表示正在解析请求行。</li>
<li><code>m_linger = false;</code>：将<code>m_linger</code>设置为false，表示不使用长连接。</li>
<li><code>m_method = GET;</code>：将请求方法设置为GET。</li>
<li><code>m_url = 0;</code>、<code>m_version = 0;</code>、<code>m_host = 0;</code>：将与请求相关的指针设置为0，表示未初始化。</li>
<li><code>m_start_line = 0;</code>：将解析开始位置设置为0。</li>
<li><code>m_checked_idx = 0;</code>：将解析进行位置设置为0。</li>
<li><code>m_read_idx = 0;</code>：将已读数据结尾位置设置为0。</li>
<li><code>m_write_idx = 0;</code>：将已写数据结尾位置设置为0。</li>
<li><code>cgi = 0;</code>：将CGI标志设置为0。</li>
<li><code>m_state = 0;</code>：将Reactor区分读写任务的标志设置为0，表示当前状态为读。</li>
<li><code>timer_flag = 0;</code>：将<code>timer_flag</code>设置为0，表示Reactor是否处理数据。</li>
<li><code>improv = 0;</code>：将<code>improv</code>设置为0，表示Reactor是否处理失败。</li>
<li><code>memset(m_read_buf, 0, READ_BUFFER_SIZE);</code>：使用<code>memset</code>函数将<code>m_read_buf</code>数组中的所有元素设置为0。</li>
<li><code>memset(m_write_buf, 0, WRITE_BUFFER_SIZE);</code>：使用<code>memset</code>函数将<code>m_write_buf</code>数组中的所有元素设置为0。</li>
<li><code>memset(m_real_file, 0, FILENAME_LEN);</code>：使用<code>memset</code>函数将<code>m_real_file</code>数组中的所有元素设置为0。</li>
</ol>
<p>这个函数的作用是将<code>http_conn</code>类的各个成员变量重置为初始状态，以便处理新接受的连接。</p>
<h3 id="初始化连接-init"><a href="#初始化连接-init" class="headerlink" title="初始化连接 init"></a>初始化连接 init</h3><p>这段代码是<code>http_conn</code>类的成员函数<code>init</code>的另一种实现，用于初始化连接。该函数接受多个参数，包括套接字描述符（<code>sockfd</code>）、客户端地址信息（<code>addr</code>）、根目录（<code>root</code>）、触发模式（<code>TRIGMode</code>）、是否关闭日志（<code>close_log</code>）、数据库用户名（<code>user</code>）、数据库密码（<code>passwd</code>）以及数据库名（<code>sqlname</code>）。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 初始化连接</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">http_conn::init</span><span class="params">(<span class="type">int</span> sockfd, <span class="type">const</span> sockaddr_in &amp;addr, <span class="type">const</span> <span class="type">char</span> *root, <span class="type">int</span> TRIGMode, </span></span></span><br><span class="line"><span class="params"><span class="function">                     <span class="type">int</span> close_log, string user, string passwd, string sqlname)</span></span>&#123;</span><br><span class="line">    m_sockfd = sockfd;</span><br><span class="line">    m_address = addr;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">addfd</span>(m_epollfd, sockfd, <span class="literal">true</span>, m_TRIGMode);</span><br><span class="line">    m_user_count++;</span><br><span class="line"></span><br><span class="line">    doc_root = root;</span><br><span class="line">    m_TRIGMode = TRIGMode;</span><br><span class="line">    m_close_log = close_log;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">strcpy</span>(sql_user, user.<span class="built_in">c_str</span>());</span><br><span class="line">    <span class="built_in">strcpy</span>(sql_passwd, passwd.<span class="built_in">c_str</span>());</span><br><span class="line">    <span class="built_in">strcpy</span>(sql_name, sqlname.<span class="built_in">c_str</span>());</span><br><span class="line"></span><br><span class="line">    <span class="built_in">init</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li><code>m_sockfd = sockfd;</code>：将成员变量<code>m_sockfd</code>设置为传入的套接字描述符。</li>
<li><code>m_address = addr;</code>：将成员变量<code>m_address</code>设置为传入的客户端地址信息。</li>
<li><code>addfd(m_epollfd, sockfd, true, m_TRIGMode);</code>：调用之前定义的<code>addfd</code>函数，将套接字描述符注册到内核事件表中，同时设置EPOLLONESHOT标志。</li>
<li><code>m_user_count++;</code>：增加静态成员变量<code>m_user_count</code>，表示当前的客户数量增加了一个。</li>
<li><code>doc_root = root;</code>：将成员变量<code>doc_root</code>设置为传入的根目录。</li>
<li><code>m_TRIGMode = TRIGMode;</code>：将成员变量<code>m_TRIGMode</code>设置为传入的触发模式。</li>
<li><code>m_close_log = close_log;</code>：将成员变量<code>m_close_log</code>设置为传入的是否关闭日志标志。</li>
<li><code>strcpy(sql_user, user.c_str());</code>、<code>strcpy(sql_passwd, passwd.c_str());</code>、<code>strcpy(sql_name, sqlname.c_str());</code>：将数据库用户名、密码和数据库名拷贝到相应的成员变量中。</li>
<li><code>init();</code>：调用之前定义的<code>init</code>函数，将<code>http_conn</code>类的各个成员变量重置为初始状态。</li>
</ol>
<p>这个函数的作用是初始化<code>http_conn</code>类的连接信息，包括套接字描述符、地址信息、根目录、触发模式等，并将连接注册到内核事件表中。</p>
<h3 id="分析一行内容-parse-line"><a href="#分析一行内容-parse-line" class="headerlink" title="分析一行内容 parse_line"></a>分析一行内容 parse_line</h3><p>这段代码是<code>http_conn</code>类的成员函数<code>parse_line</code>的实现，用于从状态机中分析一行内容。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 从状态机，用于分析一行内容</span></span><br><span class="line"><span class="function">http_conn::LINE_STATUS <span class="title">http_conn::parse_line</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="type">char</span> temp;</span><br><span class="line">    <span class="comment">//m_read_idx指向缓冲区m_read_buf的数据末尾的下一个字节</span></span><br><span class="line">    <span class="comment">//m_checked_idx指向从状态机当前正在分析的字节</span></span><br><span class="line">    <span class="keyword">for</span>(; m_checked_idx &lt; m_read_idx; ++m_checked_idx)&#123;</span><br><span class="line">        temp = m_read_buf[m_checked_idx];</span><br><span class="line">        <span class="comment">// 可能读取到完整行</span></span><br><span class="line">        <span class="keyword">if</span>(temp == <span class="string">&#x27;\r&#x27;</span>)&#123;</span><br><span class="line">            <span class="comment">// 不完整</span></span><br><span class="line">            <span class="keyword">if</span>((m_checked_idx + <span class="number">1</span>) == m_read_idx)&#123;</span><br><span class="line">                <span class="keyword">return</span> LINE_OPEN;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 完整，\r\n替换为\0\0</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span>(m_read_buf[m_checked_idx + <span class="number">1</span>] == <span class="string">&#x27;\n&#x27;</span>)&#123;</span><br><span class="line">                m_read_buf[m_checked_idx++] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">                m_read_buf[m_checked_idx++] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">                <span class="keyword">return</span> LINE_OK;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 格式错误</span></span><br><span class="line">            <span class="keyword">return</span> LINE_BAD;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 可能读取到完整行</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(temp == <span class="string">&#x27;\n&#x27;</span>)&#123;</span><br><span class="line">            <span class="comment">// 完整，\r\n替换为\0\0</span></span><br><span class="line">            <span class="keyword">if</span>(m_checked_idx &gt; <span class="number">1</span> &amp;&amp; m_read_buf[m_checked_idx - <span class="number">1</span>] == <span class="string">&#x27;\r&#x27;</span>)&#123;</span><br><span class="line">                m_read_buf[m_checked_idx - <span class="number">1</span>] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">                m_read_buf[m_checked_idx++] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">                <span class="keyword">return</span> LINE_OK;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> LINE_BAD;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 继续接收</span></span><br><span class="line">    <span class="keyword">return</span> LINE_OPEN;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li><code>char temp;</code>：定义一个临时变量<code>temp</code>，用于存储当前分析的字符。</li>
<li><code>for(; m_checked_idx &lt; m_read_idx; ++m_checked_idx)</code>：循环遍历已经读取的数据缓冲区<code>m_read_buf</code>中的内容，从<code>m_checked_idx</code>开始，直到当前已读取的数据结尾<code>m_read_idx</code>。</li>
<li><code>temp = m_read_buf[m_checked_idx];</code>：获取当前分析的字符。</li>
<li><code>if(temp == &#39;\r&#39;)</code>：判断当前字符是否为回车符（<code>\r</code>），如果是，表示可能读取到了一行。<ul>
<li><code>if((m_checked_idx + 1) == m_read_idx)</code>：如果回车符后面没有字符了，表示不完整的行，返回<code>LINE_OPEN</code>，继续接收数据。</li>
<li><code>else if(m_read_buf[m_checked_idx + 1] == &#39;\n&#39;)</code>：如果回车符后面是换行符（<code>\n</code>），表示读取到了完整的一行，将<code>\r\n</code>替换为<code>\0\0</code>，并返回<code>LINE_OK</code>。</li>
<li><code>else</code>：如果回车符后面不是换行符，表示行格式错误，返回<code>LINE_BAD</code>。</li>
</ul>
</li>
<li><code>else if(temp == &#39;\n&#39;)</code>：如果当前字符是换行符（<code>\n</code>），表示可能读取到了一行。<ul>
<li><code>if(m_checked_idx &gt; 1 &amp;&amp; m_read_buf[m_checked_idx - 1] == &#39;\r&#39;)</code>：如果换行符前面是回车符，表示读取到了完整的一行，将<code>\r\n</code>替换为<code>\0\0</code>，并返回<code>LINE_OK</code>。</li>
<li><code>else</code>：如果换行符前面不是回车符，表示行格式错误，返回<code>LINE_BAD</code>。</li>
</ul>
</li>
<li>如果以上条件都不满足，继续循环，继续接收数据，返回<code>LINE_OPEN</code>。</li>
</ol>
<p>这个函数的主要目的是在已接收的数据中分析一行内容，判断是否读取到了完整的一行，并进行相应的处理。</p>
<h3 id="循环读取客户数据-read-once"><a href="#循环读取客户数据-read-once" class="headerlink" title="循环读取客户数据 read_once"></a>循环读取客户数据 read_once</h3><p>这段代码是<code>http_conn</code>类的成员函数<code>read_once</code>的实现，用于循环读取客户端数据，直到无数据可读或对方关闭连接。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 循环读取客户数据，直到无数据可读或对方关闭连接</span></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">http_conn::read_once</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(m_read_idx &gt;= READ_BUFFER_SIZE)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">int</span> bytes_read = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// LT模式</span></span><br><span class="line">    <span class="keyword">if</span>(m_TRIGMode == <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="comment">// 读取数据到缓冲区</span></span><br><span class="line">        bytes_read = <span class="built_in">recv</span>(m_sockfd, m_read_buf + m_read_idx, READ_BUFFER_SIZE - m_read_idx, <span class="number">0</span>);</span><br><span class="line">        m_read_idx += bytes_read;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(bytes_read &lt;= <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ET模式</span></span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">while</span>(<span class="literal">true</span>)&#123;</span><br><span class="line">            bytes_read = <span class="built_in">recv</span>(m_sockfd, m_read_buf + m_read_idx, READ_BUFFER_SIZE - m_read_idx, <span class="number">0</span>);</span><br><span class="line">            <span class="comment">// 无数据可读</span></span><br><span class="line">            <span class="keyword">if</span>(bytes_read == <span class="number">-1</span>)&#123;</span><br><span class="line">                <span class="comment">// 非阻塞、连接正常</span></span><br><span class="line">                <span class="keyword">if</span>(errno == EAGAIN || errno == EWOULDBLOCK)</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 另一端已关闭</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span>(bytes_read == <span class="number">0</span>)&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            m_read_idx += bytes_read;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li><code>if(m_read_idx &gt;= READ_BUFFER_SIZE)</code>：判断当前已读取的数据是否已经达到缓冲区的最大容量，如果是，返回<code>false</code>，表示缓冲区已满，无法再读取更多数据。</li>
<li><code>int bytes_read = 0;</code>：定义一个变量<code>bytes_read</code>，用于存储每次读取的字节数。</li>
<li><code>if(m_TRIGMode == 0)</code>：如果是LT模式（level-triggered模式）。<ul>
<li><code>bytes_read = recv(m_sockfd, m_read_buf + m_read_idx, READ_BUFFER_SIZE - m_read_idx, 0);</code>：调用<code>recv</code>函数从套接字中读取数据到缓冲区中。</li>
<li><code>m_read_idx += bytes_read;</code>：更新已读取的数据结尾位置。</li>
<li><code>if(bytes_read &lt;= 0)</code>：如果读取的字节数小于等于0，表示对方关闭了连接或发生了错误，返回<code>false</code>。</li>
<li>返回<code>true</code>，表示读取数据成功。</li>
</ul>
</li>
<li><code>else</code>：如果是ET模式（edge-triggered模式）。<ul>
<li><code>while(true)</code>：进入无限循环，持续读取数据。<ul>
<li><code>bytes_read = recv(m_sockfd, m_read_buf + m_read_idx, READ_BUFFER_SIZE - m_read_idx, 0);</code>：调用<code>recv</code>函数从套接字中读取数据到缓冲区中。</li>
<li><code>if(bytes_read == -1)</code>：如果读取的字节数为-1，表示无数据可读。<ul>
<li><code>if(errno == EAGAIN || errno == EWOULDBLOCK)</code>：如果是非阻塞模式，并且连接正常，退出循环，表示当前没有更多数据可读。<ul>
<li><code>break;</code></li>
</ul>
</li>
<li>返回<code>false</code>，表示发生了错误或对方关闭了连接。</li>
</ul>
</li>
<li><code>else if(bytes_read == 0)</code>：如果读取的字节数为0，表示对方已关闭了连接，返回<code>false</code>。</li>
<li><code>m_read_idx += bytes_read;</code>：更新已读取的数据结尾位置。</li>
</ul>
</li>
<li>返回<code>true</code>，表示读取数据成功。</li>
</ul>
</li>
</ol>
<p>这个函数的主要目的是在LT或ET模式下，从套接字中循环读取数据，直到无数据可读或对方关闭连接。在ET模式下，通过循环读取保证将所有的可读数据都读取出来。</p>
<h3 id="解析HTTP请求行-parse-request-line"><a href="#解析HTTP请求行-parse-request-line" class="headerlink" title="解析HTTP请求行 parse_request_line"></a>解析HTTP请求行 parse_request_line</h3><p>这段代码是<code>http_conn</code>类的成员函数<code>parse_request_line</code>的实现，用于解析HTTP请求行，获取请求方法、目标URL及HTTP版本号。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 解析HTTP请求行，获得请求方法、目标url及http版本号</span></span><br><span class="line"><span class="function">http_conn::HTTP_CODE <span class="title">http_conn::parse_request_line</span><span class="params">(<span class="type">char</span> *text)</span></span>&#123;</span><br><span class="line">    <span class="comment">// 寻找空格和\t位置</span></span><br><span class="line">    m_url = <span class="built_in">strpbrk</span>(text, <span class="string">&quot; \t&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>(!m_url)&#123;</span><br><span class="line">        <span class="keyword">return</span> BAD_REQUEST;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 将该位置改为\0，方便取出</span></span><br><span class="line">    *m_url++ = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">    <span class="comment">// 取出请求方法并比较</span></span><br><span class="line">    <span class="type">char</span> *method = text;</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">strcasecmp</span>(method, <span class="string">&quot;GET&quot;</span>) == <span class="number">0</span>)</span><br><span class="line">        m_method = GET;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(<span class="built_in">strcasecmp</span>(method, <span class="string">&quot;POST&quot;</span>) == <span class="number">0</span>)&#123;</span><br><span class="line">        m_method = POST;</span><br><span class="line">        cgi = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">return</span> BAD_REQUEST;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 跳过空格和\t</span></span><br><span class="line">    m_url += <span class="built_in">strspn</span>(m_url, <span class="string">&quot; \t&quot;</span>);</span><br><span class="line">    <span class="comment">// 再寻找空格和\t</span></span><br><span class="line">    m_version = <span class="built_in">strpbrk</span>(m_url, <span class="string">&quot; \t&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>(!m_version)</span><br><span class="line">        <span class="keyword">return</span> BAD_REQUEST;</span><br><span class="line">    *m_version++ = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">    <span class="comment">// 跳过空格和\t</span></span><br><span class="line">    m_version += <span class="built_in">strspn</span>(m_version, <span class="string">&quot; \t&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 仅支持HTTP1.1</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">strcasecmp</span>(m_version, <span class="string">&quot;HTTP/1.1&quot;</span>) != <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> BAD_REQUEST;</span><br><span class="line">    <span class="comment">// 去除http://</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">strncasecmp</span>(m_url, <span class="string">&quot;http://&quot;</span>, <span class="number">7</span>) == <span class="number">0</span>)&#123;</span><br><span class="line">        m_url += <span class="number">7</span>;</span><br><span class="line">        m_url = <span class="built_in">strchr</span>(m_url, <span class="string">&#x27;/&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 去除https://</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">strncasecmp</span>(m_url, <span class="string">&quot;https://&quot;</span>, <span class="number">8</span>) == <span class="number">0</span>)&#123;</span><br><span class="line">        m_url += <span class="number">8</span>;</span><br><span class="line">        m_url = <span class="built_in">strchr</span>(m_url, <span class="string">&#x27;/&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(!m_url || m_url[<span class="number">0</span>] != <span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> BAD_REQUEST;</span><br><span class="line">    <span class="comment">// url为/，显示主页</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">strlen</span>(m_url) == <span class="number">1</span>)</span><br><span class="line">        <span class="built_in">strcat</span>(m_url, <span class="string">&quot;judge.html&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 主状态机状态修改为处理请求头</span></span><br><span class="line">    m_check_state = CHECK_STATE_HEADER;</span><br><span class="line">    <span class="keyword">return</span> NO_REQUEST;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ol>
<li><code>m_url = strpbrk(text, &quot; \t&quot;);</code>：在请求行中寻找空格和制表符的位置，返回第一个匹配的位置，赋值给<code>m_url</code>。如果没有找到，返回<code>BAD_REQUEST</code>，表示请求行格式错误。</li>
<li><code>if(!m_url)</code>：如果<code>m_url</code>为空，返回<code>BAD_REQUEST</code>，表示请求行格式错误。</li>
<li><code>*m_url++ = &#39;\0&#39;;</code>：将<code>m_url</code>指向的位置改为<code>\0</code>，即将请求方法和URL分隔开。</li>
<li><code>char *method = text;</code>：将<code>method</code>指针指向请求行的开始位置，即请求方法的起始位置。</li>
<li><code>if(strcasecmp(method, &quot;GET&quot;) == 0)</code>：比较请求方法是否为”GET”，如果是，将<code>m_method</code>设置为<code>GET</code>；否则，如果是”POST”，将<code>m_method</code>设置为<code>POST</code>，并设置<code>cgi</code>标志为1（表示启用CGI）；否则，返回<code>BAD_REQUEST</code>，表示请求方法不支持。</li>
<li><code>m_url += strspn(m_url, &quot; \t&quot;);</code>：跳过空格和制表符，将<code>m_url</code>指向下一个非空白字符。</li>
<li><code>m_version = strpbrk(m_url, &quot; \t&quot;);</code>：在新的位置继续寻找空格和制表符的位置，返回第一个匹配的位置，赋值给<code>m_version</code>。如果没有找到，返回<code>BAD_REQUEST</code>，表示请求行格式错误。</li>
<li><code>if(!m_version)</code>：如果<code>m_version</code>为空，返回<code>BAD_REQUEST</code>，表示请求行格式错误。</li>
<li><code>*m_version++ = &#39;\0&#39;;</code>：将<code>m_version</code>指向的位置改为<code>\0</code>，即将URL和HTTP版本号分隔开。</li>
<li><code>m_version += strspn(m_version, &quot; \t&quot;);</code>：跳过空格和制表符，将<code>m_version</code>指向下一个非空白字符。</li>
<li><code>if(strcasecmp(m_version, &quot;HTTP/1.1&quot;) != 0)</code>：比较HTTP版本号是否为”HTTP&#x2F;1.1”，如果不是，返回<code>BAD_REQUEST</code>，表示不支持的HTTP版本。</li>
<li><code>if(strncasecmp(m_url, &quot;http://&quot;, 7) == 0)</code>：如果URL以”http:&#x2F;&#x2F;“开头，去除该部分。</li>
<li><code>if(strncasecmp(m_url, &quot;https://&quot;, 8) == 0)</code>：如果URL以”https:&#x2F;&#x2F;“开头，去除该部分。</li>
<li><code>if(!m_url || m_url[0] != &#39;/&#39;)</code>：如果URL为空或者不以’&#x2F;‘开头，返回<code>BAD_REQUEST</code>，表示请求行格式错误。</li>
<li><code>if(strlen(m_url) == 1)</code>：如果URL长度为1，表示只有’&#x2F;‘，将其拼接为”judge.html”，作为默认的主页。</li>
<li><code>m_check_state = CHECK_STATE_HEADER;</code>：将主状态机状态修改为处理请求头。</li>
<li><code>return NO_REQUEST;</code>：返回<code>NO_REQUEST</code>，表示成功解析请求行。</li>
</ol>
<p>这个函数的主要目的是解析HTTP请求行，获取请求方法、目标URL及HTTP版本号，并进行相应的处理。</p>
<h3 id="解析HTTP请求头-parse-headers"><a href="#解析HTTP请求头-parse-headers" class="headerlink" title="解析HTTP请求头 parse_headers"></a>解析HTTP请求头 parse_headers</h3><p>这段代码是<code>http_conn</code>类的成员函数<code>parse_headers</code>的实现，用于解析HTTP请求的一个头部信息。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 解析HTTP请求的一个头部信息</span></span><br><span class="line"><span class="function">http_conn::HTTP_CODE <span class="title">http_conn::parse_headers</span><span class="params">(<span class="type">char</span> *text)</span></span>&#123;</span><br><span class="line">    <span class="comment">// 首位为\0是空行</span></span><br><span class="line">    <span class="keyword">if</span>(text[<span class="number">0</span>] == <span class="string">&#x27;\0&#x27;</span>)&#123;</span><br><span class="line">        <span class="keyword">if</span>(m_content_length != <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="comment">// POST继续解析消息体</span></span><br><span class="line">            m_check_state = CHECK_STATE_CONTENT;</span><br><span class="line">            <span class="keyword">return</span> NO_REQUEST;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// GET请求解析完成</span></span><br><span class="line">        <span class="keyword">return</span> GET_REQUEST;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 连接字段</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(<span class="built_in">strncasecmp</span>(text, <span class="string">&quot;connection:&quot;</span>, <span class="number">11</span>) == <span class="number">0</span>)&#123;</span><br><span class="line">        text += <span class="number">11</span>;</span><br><span class="line">        text += <span class="built_in">strspn</span>(text, <span class="string">&quot; \t&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">strcasecmp</span>(text, <span class="string">&quot;keep-alive&quot;</span>) == <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="comment">// 长连接</span></span><br><span class="line">            m_linger = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 内容长度字段</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(<span class="built_in">strncasecmp</span>(text, <span class="string">&quot;Content-length:&quot;</span>, <span class="number">15</span>) == <span class="number">0</span>)&#123;</span><br><span class="line">        text += <span class="number">15</span>;</span><br><span class="line">        text += <span class="built_in">strspn</span>(text, <span class="string">&quot;\t&quot;</span>);</span><br><span class="line">        m_content_length = <span class="built_in">atol</span>(text);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Host字段，请求站点</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(<span class="built_in">strncasecmp</span>(text, <span class="string">&quot;Host:&quot;</span>, <span class="number">5</span>) == <span class="number">0</span>)&#123;</span><br><span class="line">        text += <span class="number">5</span>;</span><br><span class="line">        text += <span class="built_in">strspn</span>(text, <span class="string">&quot; \t&quot;</span>);</span><br><span class="line">        m_host = text;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="built_in">LOG_INFO</span>(<span class="string">&quot;oop! unknow header: %s&quot;</span>, text);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> NO_REQUEST;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li><code>if(text[0] == &#39;\0&#39;)</code>：判断头部信息的首位是否为<code>\0</code>，如果是，表示空行，说明当前请求的头部信息解析完成。<ul>
<li><code>if(m_content_length != 0)</code>：如果请求方法是POST且有消息体，将主状态机状态修改为处理请求体，返回<code>NO_REQUEST</code>。</li>
<li>否则，表示GET请求头部解析完成，返回<code>GET_REQUEST</code>。</li>
</ul>
</li>
<li><code>else if(strncasecmp(text, &quot;connection:&quot;, 11) == 0)</code>：如果头部字段以”Connection:”开头，表示连接字段。<ul>
<li><code>text += 11;</code>：跳过”Connection:”部分。</li>
<li><code>text += strspn(text, &quot; \t&quot;);</code>：跳过空格和制表符，指向字段值的开始。</li>
<li><code>if(strcasecmp(text, &quot;keep-alive&quot;) == 0)</code>：如果字段值为”keep-alive”，表示使用长连接，将<code>m_linger</code>标志设置为<code>true</code>。</li>
</ul>
</li>
<li><code>else if(strncasecmp(text, &quot;Content-length:&quot;, 15) == 0)</code>：如果头部字段以”Content-length:”开头，表示内容长度字段。<ul>
<li><code>text += 15;</code>：跳过”Content-length:”部分。</li>
<li><code>text += strspn(text, &quot;\t&quot;);</code>：跳过制表符，指向字段值的开始。</li>
<li><code>m_content_length = atol(text);</code>：将字段值转换为长整型，表示消息体的长度。</li>
</ul>
</li>
<li><code>else if(strncasecmp(text, &quot;Host:&quot;, 5) == 0)</code>：如果头部字段以”Host:”开头，表示Host字段，即请求的站点。<ul>
<li><code>text += 5;</code>：跳过”Host:”部分。</li>
<li><code>text += strspn(text, &quot; \t&quot;);</code>：跳过空格和制表符，指向字段值的开始。</li>
<li><code>m_host = text;</code>：将<code>m_host</code>指针指向Host字段的值，即请求的站点。</li>
</ul>
</li>
<li><code>else</code>：如果是其他未知的头部字段，输出日志记录。</li>
<li>返回<code>NO_REQUEST</code>，表示继续解析后续的头部信息。</li>
</ol>
<p>这个函数的主要目的是解析HTTP请求的一个头部信息，包括连接字段、内容长度字段和Host字段。在解析过程中，如果发现空行，表示当前请求的头部信息解析完成，根据情况进行处理。</p>
<h3 id="判断HTTP请求是否被完全读入-parse-content"><a href="#判断HTTP请求是否被完全读入-parse-content" class="headerlink" title="判断HTTP请求是否被完全读入 parse_content"></a>判断HTTP请求是否被完全读入 parse_content</h3><p>这段代码是<code>http_conn</code>类的成员函数<code>parse_content</code>的实现，用于判断HTTP请求是否已经完全读入消息体。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 判断HTTP请求是否被完全读入</span></span><br><span class="line"><span class="function">http_conn::HTTP_CODE <span class="title">http_conn::parse_content</span><span class="params">(<span class="type">char</span> *text)</span></span>&#123;</span><br><span class="line">    <span class="comment">// 判断buffer中是否读取了消息体</span></span><br><span class="line">    <span class="keyword">if</span>(m_read_idx &gt;= (m_content_length + m_checked_idx))&#123;</span><br><span class="line">        <span class="comment">// 最后填充\0</span></span><br><span class="line">        text[m_content_length] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">        <span class="comment">// 获取消息体</span></span><br><span class="line">        m_string = text;</span><br><span class="line">        <span class="keyword">return</span> GET_REQUEST;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> NO_REQUEST;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li><code>if(m_read_idx &gt;= (m_content_length + m_checked_idx))</code>：判断当前已读取的数据长度是否大于等于消息体长度加上已解析的数据位置。<ul>
<li><code>text[m_content_length] = &#39;\0&#39;;</code>：在消息体结束位置填充<code>\0</code>，将消息体转换为以<code>\0</code>结尾的字符串。</li>
<li><code>m_string = text;</code>：将<code>m_string</code>指针指向消息体的起始位置，即请求体的内容。</li>
<li>返回<code>GET_REQUEST</code>，表示HTTP请求的消息体已经完全读入。</li>
</ul>
</li>
<li>返回<code>NO_REQUEST</code>，表示HTTP请求的消息体还未完全读入，需要继续读取。</li>
</ol>
<h3 id="处理接收到的HTTP请求数据-process-read"><a href="#处理接收到的HTTP请求数据-process-read" class="headerlink" title="处理接收到的HTTP请求数据 process_read"></a>处理接收到的HTTP请求数据 process_read</h3><p>这段代码是<code>http_conn</code>类的成员函数<code>process_read</code>的实现，用于处理接收到的HTTP请求数据。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">http_conn::HTTP_CODE <span class="title">http_conn::process_read</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 初始化状态</span></span><br><span class="line">    LINE_STATUS line_status = LINE_OK;</span><br><span class="line">    HTTP_CODE ret = NO_REQUEST;</span><br><span class="line">    <span class="type">char</span> *text = <span class="literal">nullptr</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 消息体末尾没有字符，POST请求报文不能用从状态机LINE_OK状态判断</span></span><br><span class="line">    <span class="comment">// 加上&amp;&amp; line_status == LINE_OK防止陷入死循环</span></span><br><span class="line">    <span class="keyword">while</span>((m_check_state == CHECK_STATE_CONTENT &amp;&amp; line_status == LINE_OK) || ((line_status = <span class="built_in">parse_line</span>()) == LINE_OK))&#123;</span><br><span class="line">        <span class="comment">// 取一行数据</span></span><br><span class="line">        text = <span class="built_in">get_line</span>();</span><br><span class="line">        m_start_line = m_checked_idx;</span><br><span class="line">        <span class="built_in">LOG_INFO</span>(<span class="string">&quot;get line: %s&quot;</span>, text);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 主状态机状态</span></span><br><span class="line">        <span class="keyword">switch</span> (m_check_state)&#123;</span><br><span class="line">            <span class="keyword">case</span> CHECK_STATE_REQUESTLINE:&#123;</span><br><span class="line">                ret = <span class="built_in">parse_request_line</span>(text);</span><br><span class="line">                <span class="keyword">if</span>(ret == BAD_REQUEST)</span><br><span class="line">                    <span class="keyword">return</span> BAD_REQUEST;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">case</span> CHECK_STATE_HEADER:&#123;</span><br><span class="line">                ret = <span class="built_in">parse_headers</span>(text);</span><br><span class="line">                <span class="keyword">if</span>(ret == BAD_REQUEST)</span><br><span class="line">                    <span class="keyword">return</span> BAD_REQUEST;</span><br><span class="line">                <span class="comment">// 完整解析GET请求</span></span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span>(ret == GET_REQUEST)</span><br><span class="line">                    <span class="keyword">return</span> <span class="built_in">do_request</span>();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">case</span> CHECK_STATE_CONTENT:&#123;</span><br><span class="line">                ret = <span class="built_in">parse_content</span>(text);</span><br><span class="line">                <span class="comment">// 完整解析POST请求</span></span><br><span class="line">                <span class="keyword">if</span>(ret == GET_REQUEST)</span><br><span class="line">                    <span class="keyword">return</span> <span class="built_in">do_request</span>();</span><br><span class="line">                <span class="comment">// 完成报文解析，防止进入循环</span></span><br><span class="line">                line_status = LINE_OPEN;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">return</span> INTERNAL_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> NO_REQUEST;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li><p><code>LINE_STATUS line_status = LINE_OK;</code>：初始化行状态为<code>LINE_OK</code>，表示当前行的状态正常。</p>
</li>
<li><p><code>HTTP_CODE ret = NO_REQUEST;</code>：初始化HTTP处理状态为<code>NO_REQUEST</code>，表示当前没有完整的HTTP请求。</p>
</li>
<li><p><code>char *text = nullptr;</code>：初始化字符指针<code>text</code>为空指针。</p>
</li>
<li><pre><code>while((m_check_state == CHECK_STATE_CONTENT &amp;&amp; line_status == LINE_OK) || ((line_status = parse_line()) == LINE_OK))
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">：循环条件，如果当前主状态机状态是解析消息体并且当前行状态是OK，或者解析行的状态是OK，则进入循环。</span><br><span class="line"></span><br><span class="line">- `text = get_line();`：获取一行数据，`get_line()`函数返回指向当前行的指针，并将`m_start_line`设置为当前解析位置。</span><br><span class="line"></span><br><span class="line">- `m_start_line = m_checked_idx;`：更新解析起始位置。</span><br><span class="line"></span><br><span class="line">- `LOG_INFO(&quot;get line: %s&quot;, text);`：记录日志，输出获取的行数据。</span><br><span class="line"></span><br><span class="line">- ```</span><br><span class="line">  switch (m_check_state)&#123;</span><br></pre></td></tr></table></figure>

  ：根据主状态机的状态进行处理。

  - `case CHECK_STATE_REQUESTLINE:`：处理请求行，调用`parse_request_line`函数解析请求行，返回相应的处理结果，如果是`BAD_REQUEST`，返回`BAD_REQUEST`；如果是`GET_REQUEST`，则调用`do_request`函数进行处理。
  - `case CHECK_STATE_HEADER:`：处理请求头，调用`parse_headers`函数解析请求头，返回相应的处理结果，如果是`BAD_REQUEST`，返回`BAD_REQUEST`；如果是`GET_REQUEST`，则调用`do_request`函数进行处理。
  - `case CHECK_STATE_CONTENT:`：处理请求体，调用`parse_content`函数解析请求体，返回相应的处理结果，如果是`GET_REQUEST`，则调用`do_request`函数进行处理；将行状态设置为`LINE_OPEN`，防止进入死循环。
  - `default:`：如果状态无法匹配，返回`INTERNAL_ERROR`，表示内部错误。
</code></pre>
</li>
<li><p><code>return NO_REQUEST;</code>：最终返回<code>NO_REQUEST</code>，表示处理完成，等待下一次读取请求。</p>
</li>
</ol>
<h3 id="请求实现-do-request"><a href="#请求实现-do-request" class="headerlink" title="请求实现 do_request"></a>请求实现 do_request</h3><p>这段代码是<code>http_conn</code>类的成员函数<code>do_request</code>的实现，用于处理HTTP请求。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">http_conn::HTTP_CODE <span class="title">http_conn::do_request</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="comment">// 网站根目录</span></span><br><span class="line">    <span class="built_in">strcpy</span>(m_real_file, doc_root);</span><br><span class="line">    <span class="type">int</span> len = <span class="built_in">strlen</span>(doc_root);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 找到最后一个/的位置</span></span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *p = <span class="built_in">strrchr</span>(m_url, <span class="string">&#x27;/&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// POST请求，实现登录和注册校验</span></span><br><span class="line">    <span class="keyword">if</span>(cgi == <span class="number">1</span> &amp;&amp; (*(p + <span class="number">1</span>) == <span class="string">&#x27;2&#x27;</span> || *(p + <span class="number">1</span>) == <span class="string">&#x27;3&#x27;</span>))&#123;</span><br><span class="line">        <span class="type">char</span> *m_url_real = (<span class="type">char</span> *)<span class="built_in">malloc</span>(<span class="built_in">sizeof</span>(<span class="type">char</span>) * <span class="number">200</span>);</span><br><span class="line">        <span class="built_in">strcpy</span>(m_url_real, <span class="string">&quot;/&quot;</span>);</span><br><span class="line">        <span class="built_in">strcat</span>(m_url_real, m_url + <span class="number">2</span>);</span><br><span class="line">        <span class="built_in">strncpy</span>(m_real_file + len, m_url_real, FILENAME_LEN - len - <span class="number">1</span>);</span><br><span class="line">        <span class="built_in">free</span>(m_url_real);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 将用户名和密码提取出来</span></span><br><span class="line">        <span class="comment">// user=123&amp;password=123</span></span><br><span class="line">        <span class="type">char</span> name[<span class="number">100</span>], password[<span class="number">100</span>];</span><br><span class="line">        <span class="type">int</span> i;</span><br><span class="line">        <span class="keyword">for</span>(i = <span class="number">5</span>; m_string[i] != <span class="string">&#x27;&amp;&#x27;</span>; ++i)</span><br><span class="line">            name[i - <span class="number">5</span>] = m_string[i];</span><br><span class="line">        name[i - <span class="number">5</span>] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> j = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(i = i + <span class="number">10</span>; m_string[i] != <span class="string">&#x27;\0&#x27;</span>; ++i, ++j)</span><br><span class="line">            password[j] = m_string[i];</span><br><span class="line">        password[j] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(*(p + <span class="number">1</span>) == <span class="string">&#x27;3&#x27;</span>)&#123;</span><br><span class="line">            <span class="comment">//如果是注册，先检测数据库中是否有重名的</span></span><br><span class="line">            <span class="comment">//没有重名的，进行增加数据</span></span><br><span class="line">            <span class="type">char</span> *sql_insert = (<span class="type">char</span> *)<span class="built_in">malloc</span>(<span class="built_in">sizeof</span>(<span class="type">char</span>) * <span class="number">200</span>);</span><br><span class="line">            <span class="built_in">strcpy</span>(sql_insert, <span class="string">&quot;INSERT INTO user(username, password) VALUES(&quot;</span>);</span><br><span class="line">            <span class="built_in">strcat</span>(sql_insert, <span class="string">&quot;&#x27;&quot;</span>);</span><br><span class="line">            <span class="built_in">strcat</span>(sql_insert, name);</span><br><span class="line">            <span class="built_in">strcat</span>(sql_insert, <span class="string">&quot;&#x27;, &#x27;&quot;</span>);</span><br><span class="line">            <span class="built_in">strcat</span>(sql_insert, password);</span><br><span class="line">            <span class="built_in">strcat</span>(sql_insert, <span class="string">&quot;&#x27;)&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(users.<span class="built_in">find</span>(name) == users.<span class="built_in">end</span>())&#123;</span><br><span class="line">                m_lock.<span class="built_in">lock</span>();</span><br><span class="line">                <span class="type">int</span> res = <span class="built_in">mysql_query</span>(mysql, sql_insert);</span><br><span class="line">                users.<span class="built_in">insert</span>(<span class="built_in">pair</span>&lt;string, string&gt;(name, password));</span><br><span class="line">                m_lock.<span class="built_in">unlock</span>();</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span>(!res)</span><br><span class="line">                    <span class="built_in">strcpy</span>(m_url, <span class="string">&quot;/log.html&quot;</span>);</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    <span class="built_in">strcpy</span>(m_url, <span class="string">&quot;/registerError.html&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                <span class="built_in">strcpy</span>(m_url, <span class="string">&quot;/registerError.html&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//如果是登录，直接判断</span></span><br><span class="line">        <span class="comment">//若浏览器端输入的用户名和密码在表中可以查找到，返回1，否则返回0</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(*(p + <span class="number">1</span>) == <span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(users.<span class="built_in">find</span>(name) != users.<span class="built_in">end</span>() &amp;&amp; users[name] == password)</span><br><span class="line">                <span class="built_in">strcpy</span>(m_url, <span class="string">&quot;/welcome.html&quot;</span>);</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                <span class="built_in">strcpy</span>(m_url, <span class="string">&quot;/logError.html&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// GET请求，跳转到注册页面</span></span><br><span class="line">    <span class="keyword">if</span>(*(p + <span class="number">1</span>) == <span class="string">&#x27;0&#x27;</span>)&#123;</span><br><span class="line">        <span class="type">char</span> *m_url_real = (<span class="type">char</span> *)<span class="built_in">malloc</span>(<span class="built_in">sizeof</span>(<span class="type">char</span>) * <span class="number">200</span>);</span><br><span class="line">        <span class="built_in">strcpy</span>(m_url_real, <span class="string">&quot;/register.html&quot;</span>);</span><br><span class="line">        <span class="built_in">strncpy</span>(m_real_file + len, m_url_real, <span class="built_in">strlen</span>(m_url_real));</span><br><span class="line"></span><br><span class="line">        <span class="built_in">free</span>(m_url_real);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// GET请求，跳转到登录页面</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(*(p + <span class="number">1</span>) == <span class="string">&#x27;1&#x27;</span>)&#123;</span><br><span class="line">        <span class="type">char</span> *m_url_real = (<span class="type">char</span> *)<span class="built_in">malloc</span>(<span class="built_in">sizeof</span>(<span class="type">char</span>) * <span class="number">200</span>);</span><br><span class="line">        <span class="built_in">strcpy</span>(m_url_real, <span class="string">&quot;/log.html&quot;</span>);</span><br><span class="line">        <span class="built_in">strncpy</span>(m_real_file + len, m_url_real, <span class="built_in">strlen</span>(m_url_real));</span><br><span class="line"></span><br><span class="line">        <span class="built_in">free</span>(m_url_real);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// POST请求，图片页面</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(*(p + <span class="number">1</span>) == <span class="string">&#x27;5&#x27;</span>)&#123;</span><br><span class="line">        <span class="type">char</span> *m_url_real = (<span class="type">char</span> *)<span class="built_in">malloc</span>(<span class="built_in">sizeof</span>(<span class="type">char</span>) * <span class="number">200</span>);</span><br><span class="line">        <span class="built_in">strcpy</span>(m_url_real, <span class="string">&quot;/picture.html&quot;</span>);</span><br><span class="line">        <span class="built_in">strncpy</span>(m_real_file + len, m_url_real, <span class="built_in">strlen</span>(m_url_real));</span><br><span class="line"></span><br><span class="line">        <span class="built_in">free</span>(m_url_real);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// POST请求，视频页面</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(*(p + <span class="number">1</span>) == <span class="string">&#x27;6&#x27;</span>)&#123;</span><br><span class="line">        <span class="type">char</span> *m_url_real = (<span class="type">char</span> *)<span class="built_in">malloc</span>(<span class="built_in">sizeof</span>(<span class="type">char</span>) * <span class="number">200</span>);</span><br><span class="line">        <span class="built_in">strcpy</span>(m_url_real, <span class="string">&quot;/video.html&quot;</span>);</span><br><span class="line">        <span class="built_in">strncpy</span>(m_real_file + len, m_url_real, <span class="built_in">strlen</span>(m_url_real));</span><br><span class="line"></span><br><span class="line">        <span class="built_in">free</span>(m_url_real);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// POST请求，关注页面</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(*(p + <span class="number">1</span>) == <span class="string">&#x27;7&#x27;</span>)&#123;</span><br><span class="line">        <span class="type">char</span> *m_url_real = (<span class="type">char</span> *)<span class="built_in">malloc</span>(<span class="built_in">sizeof</span>(<span class="type">char</span>) * <span class="number">200</span>);</span><br><span class="line">        <span class="built_in">strcpy</span>(m_url_real, <span class="string">&quot;/fans.html&quot;</span>);</span><br><span class="line">        <span class="built_in">strncpy</span>(m_real_file + len, m_url_real, <span class="built_in">strlen</span>(m_url_real));</span><br><span class="line"></span><br><span class="line">        <span class="built_in">free</span>(m_url_real);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="comment">// 都不是则直接拼接</span></span><br><span class="line">        <span class="built_in">strncpy</span>(m_real_file + len, m_url, FILENAME_LEN - len - <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取不到文件信息，资源不存在</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">stat</span>(m_real_file, &amp;m_file_stat) &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> NO_RESOURCE;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 文件是否可读</span></span><br><span class="line">    <span class="keyword">if</span>(!(m_file_stat.st_mode &amp; S_IROTH))</span><br><span class="line">        <span class="keyword">return</span> FORBIDDEN_REQUEST;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 文件是否为目录</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">S_ISDIR</span>(m_file_stat.st_mode))</span><br><span class="line">        <span class="keyword">return</span> BAD_REQUEST;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 以只读方式打开文件并映射到内存中</span></span><br><span class="line">    <span class="type">int</span> fd = <span class="built_in">open</span>(m_real_file, O_RDONLY);</span><br><span class="line">    m_file_address = (<span class="type">char</span> *)<span class="built_in">mmap</span>(<span class="number">0</span>, m_file_stat.st_size, PROT_READ, MAP_PRIVATE, fd, <span class="number">0</span>);</span><br><span class="line">    <span class="comment">// 关闭文件描述符</span></span><br><span class="line">    <span class="built_in">close</span>(fd);</span><br><span class="line">    <span class="keyword">return</span> FILE_REQUEST;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li><p><code>strcpy(m_real_file, doc_root);</code>：复制网站根目录到<code>m_real_file</code>。</p>
</li>
<li><p><code>const char *p = strrchr(m_url, &#39;/&#39;);</code>：找到请求URL中最后一个’&#x2F;‘的位置。</p>
</li>
<li><pre><code class="c++">if(cgi == 1 &amp;&amp; (*(p + 1) == &#39;2&#39; || *(p + 1) == &#39;3&#39;))
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">   ：判断是否是CGI请求（登录或注册）。</span><br><span class="line"></span><br><span class="line">   - `char *m_url_real = (char *)malloc(sizeof(char) * 200);`：为`m_url_real`分配内存。</span><br><span class="line">   - 根据请求类型（&#x27;2&#x27;为登录，&#x27;3&#x27;为注册），拼接请求的URL到`m_url_real`。</span><br><span class="line">   - 将`m_url_real`拼接到`m_real_file`，得到完整的文件路径。</span><br><span class="line">   - 解析POST请求中的用户名和密码，然后进行相应的处理。</span><br><span class="line"></span><br><span class="line">4. ```c++</span><br><span class="line">   else if(*(p + 1) == &#x27;0&#x27;)</span><br></pre></td></tr></table></figure>

：GET请求，跳转到注册页面。

- `char *m_url_real = (char *)malloc(sizeof(char) * 200);`：为`m_url_real`分配内存。
- 将注册页面的URL拼接到`m_url_real`，然后将其拼接到`m_real_file`。
</code></pre>
</li>
<li><pre><code class="c++">else if(*(p + 1) == &#39;1&#39;)
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">   ：GET请求，跳转到登录页面。</span><br><span class="line"></span><br><span class="line">   - `char *m_url_real = (char *)malloc(sizeof(char) * 200);`：为`m_url_real`分配内存。</span><br><span class="line">   - 将登录页面的URL拼接到`m_url_real`，然后将其拼接到`m_real_file`。</span><br><span class="line"></span><br><span class="line">6. ```c++</span><br><span class="line">   else if(*(p + 1) == &#x27;5&#x27;)</span><br></pre></td></tr></table></figure>

：POST请求，图片页面。

- 类似地处理图片、视频、关注等不同类型的页面。
</code></pre>
</li>
<li><p><code>else</code>：都不是上述情况，则直接拼接URL到<code>m_real_file</code>。</p>
</li>
<li><p><code>if(stat(m_real_file, &amp;m_file_stat) &lt; 0)</code>：获取文件信息，如果失败则返回<code>NO_RESOURCE</code>表示资源不存在。</p>
</li>
<li><p><code>if(!(m_file_stat.st_mode &amp; S_IROTH))</code>：判断文件是否可读，如果不可读则返回<code>FORBIDDEN_REQUEST</code>表示禁止访问。</p>
</li>
<li><p><code>if(S_ISDIR(m_file_stat.st_mode))</code>：判断文件是否为目录，如果是目录则返回<code>BAD_REQUEST</code>表示请求不合法。</p>
</li>
<li><p><code>int fd = open(m_real_file, O_RDONLY);</code>：以只读方式打开文件。</p>
</li>
<li><p><code>m_file_address = (char *)mmap(0, m_file_stat.st_size, PROT_READ, MAP_PRIVATE, fd, 0);</code>：将文件映射到内存中。</p>
</li>
<li><p><code>close(fd);</code>：关闭文件描述符。</p>
</li>
<li><p><code>return FILE_REQUEST;</code>：返回<code>FILE_REQUEST</code>，表示文件请求处理完成。</p>
</li>
</ol>
<h3 id="关闭文件映射-unmap"><a href="#关闭文件映射-unmap" class="headerlink" title="关闭文件映射 unmap"></a>关闭文件映射 unmap</h3><p>这段代码是<code>http_conn</code>类的成员函数<code>unmap</code>的实现，用于关闭文件映射。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 关闭文件映射</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">http_conn::unmap</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(m_file_address)&#123;</span><br><span class="line">        <span class="built_in">munmap</span>(m_file_address, m_file_stat.st_size);</span><br><span class="line">        m_file_address = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li><code>if(m_file_address)</code>：检查<code>m_file_address</code>是否非空，即是否已经映射了文件。</li>
<li><code>munmap(m_file_address, m_file_stat.st_size);</code>：调用<code>munmap</code>函数关闭文件映射，释放映射的内存。</li>
<li><code>m_file_address = 0;</code>：将<code>m_file_address</code>置为0，表示文件映射已关闭。</li>
</ol>
<h3 id="向客户端写响应-write"><a href="#向客户端写响应-write" class="headerlink" title="向客户端写响应 write"></a>向客户端写响应 write</h3><p>这段代码是<code>http_conn</code>类的成员函数<code>write</code>的实现，主要用于向客户端写响应。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 向客户端写响应</span></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">http_conn::write</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="type">int</span> temp = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 响应报文为空</span></span><br><span class="line">    <span class="keyword">if</span>(bytes_to_send == <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">modfd</span>(m_epollfd, m_sockfd, EPOLLIN, m_TRIGMode);</span><br><span class="line">        <span class="built_in">init</span>();</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">        <span class="comment">// 发送响应</span></span><br><span class="line">        temp = <span class="built_in">writev</span>(m_sockfd, m_iv, m_iv_count);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(temp &lt; <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="comment">// 重试，继续监听写事件</span></span><br><span class="line">            <span class="keyword">if</span>(errno == EAGAIN)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">modfd</span>(m_epollfd, m_sockfd, EPOLLOUT, m_TRIGMode);</span><br><span class="line">                <span class="comment">// 不要断开连接</span></span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 断开连接</span></span><br><span class="line">            <span class="built_in">unmap</span>();</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 正常发送</span></span><br><span class="line">        bytes_have_send += temp;</span><br><span class="line">        bytes_to_send -= temp;</span><br><span class="line">        <span class="comment">// 第一个元素已经发送完</span></span><br><span class="line">        <span class="keyword">if</span>(bytes_have_send &gt;= m_iv[<span class="number">0</span>].iov_len)&#123;</span><br><span class="line">            m_iv[<span class="number">0</span>].iov_len = <span class="number">0</span>;</span><br><span class="line">            m_iv[<span class="number">1</span>].iov_base = m_file_address + (bytes_have_send - m_write_idx);</span><br><span class="line">            m_iv[<span class="number">1</span>].iov_len = bytes_to_send;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 继续发送第一个元素</span></span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">            m_iv[<span class="number">0</span>].iov_base = m_write_buf + bytes_have_send;</span><br><span class="line">            m_iv[<span class="number">0</span>].iov_len = m_iv[<span class="number">0</span>].iov_len - bytes_have_send;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 全部发送完毕</span></span><br><span class="line">        <span class="keyword">if</span>(bytes_to_send &lt;= <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="built_in">unmap</span>();</span><br><span class="line">            <span class="built_in">modfd</span>(m_epollfd, m_sockfd, EPOLLIN, m_TRIGMode);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 长连接</span></span><br><span class="line">            <span class="keyword">if</span>(m_linger)&#123;</span><br><span class="line">                <span class="built_in">init</span>();</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li><p><code>if(bytes_to_send == 0)</code>：如果响应报文为空，表示数据已经发送完毕，可以修改<code>epoll</code>事件，然后初始化连接，准备处理下一个请求。</p>
</li>
<li><p><code>while(1)</code>：进入一个无限循环，用于循环发送响应数据。</p>
</li>
<li><p><code>temp = writev(m_sockfd, m_iv, m_iv_count);</code>：使用<code>writev</code>函数向客户端发送响应，<code>m_iv</code>是<code>iovec</code>结构体数组，指定了发送的数据块和长度。</p>
</li>
<li><p>判断<code>temp</code>的返回值：</p>
<ul>
<li><pre><code class="c++">temp &lt; 0
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">     ：发生错误，根据错误类型采取相应的处理措施。</span><br><span class="line"></span><br><span class="line">     - 如果是 `EAGAIN`，表示当前无法写入更多数据，此时应该修改`epoll`事件监听写事件，等待下一次写事件到来，然后继续循环。</span><br><span class="line">     - 如果是其他错误，可能是连接断开等问题，调用`unmap`关闭文件映射，然后返回`false`表示写入失败。</span><br><span class="line"></span><br><span class="line">5. `temp &gt;= 0`：正常发送数据，更新已发送和剩余待发送的字节数。如果第一个`iovec`元素的数据已经发送完毕，将其长度置为0，并更新第二个元素的位置和长度，继续发送。</span><br><span class="line"></span><br><span class="line">6. 判断`bytes_to_send`是否小于等于0：</span><br><span class="line"></span><br><span class="line">   - 如果是，表示全部数据发送完毕，调用`unmap`关闭文件映射，修改`epoll`事件为监听读事件，并根据长连接标志决定是否初始化连接准备处理下一个请求。</span><br><span class="line">   - 如果不是，继续下一轮循环，继续发送。</span><br><span class="line"></span><br><span class="line">### 写响应 add_response</span><br><span class="line"></span><br><span class="line">这段代码是`http_conn`类的成员函数`add_response`的实现，主要用于往写缓冲区中添加HTTP响应内容。</span><br><span class="line"></span><br><span class="line">```c++</span><br><span class="line">// 写响应</span><br><span class="line">bool http_conn::add_response(const char *format, ...)&#123;</span><br><span class="line">    // 写入内容超过buffer长度则报错</span><br><span class="line">    if(m_write_idx &gt;= WRITE_BUFFER_SIZE)</span><br><span class="line">        return false;</span><br><span class="line">    </span><br><span class="line">    // 可变参数列表</span><br><span class="line">    va_list arg_list;</span><br><span class="line">    // 初始化列表</span><br><span class="line">    va_start(arg_list, format);</span><br><span class="line"></span><br><span class="line">    // 按照format写入缓存</span><br><span class="line">    int len = vsnprintf(m_write_buf + m_write_idx, WRITE_BUFFER_SIZE - 1 - m_write_idx, format, arg_list);</span><br><span class="line">    // 超出缓存则报错</span><br><span class="line">    if(len &gt;= (WRITE_BUFFER_SIZE - 1 - m_write_idx))&#123;</span><br><span class="line">        va_end(arg_list);</span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 更新idx</span><br><span class="line">    m_write_idx += len;</span><br><span class="line">    va_end(arg_list);</span><br><span class="line"></span><br><span class="line">    LOG_INFO(&quot;add response: %s&quot;, m_write_buf);</span><br><span class="line">    return true;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</code></pre>
</li>
</ul>
</li>
<li><p><code>if(m_write_idx &gt;= WRITE_BUFFER_SIZE)</code>：检查写缓冲区是否已满，如果已满，则表示无法继续添加响应内容，返回<code>false</code>。</p>
</li>
<li><p><code>va_list arg_list;</code>：声明一个变量参数列表。</p>
</li>
<li><p><code>va_start(arg_list, format);</code>：初始化变量参数列表，使其指向参数列表中的第一个可变参数。</p>
</li>
<li><p><code>int len = vsnprintf(m_write_buf + m_write_idx, WRITE_BUFFER_SIZE - 1 - m_write_idx, format, arg_list);</code>：使用<code>vsnprintf</code>函数按照指定的<code>format</code>格式将可变参数列表中的内容写入写缓冲区。<code>vsnprintf</code>会根据指定的格式将可变参数列表中的内容格式化并写入指定长度的缓冲区。</p>
</li>
<li><p><code>if(len &gt;= (WRITE_BUFFER_SIZE - 1 - m_write_idx))</code>：检查写入的内容长度是否超过了写缓冲区的剩余空间，如果超过则表示写入过程中发生截断，返回<code>false</code>。</p>
</li>
<li><p><code>m_write_idx += len;</code>：更新写缓冲区的索引位置，将已写入的长度加到索引上。</p>
</li>
<li><p><code>va_end(arg_list);</code>：结束变量参数列表的使用。</p>
</li>
<li><p><code>LOG_INFO(&quot;add response: %s&quot;, m_write_buf);</code>：打印日志，记录添加的响应内容。</p>
</li>
<li><p><code>return true;</code>：表示添加响应内容成功。</p>
</li>
</ol>
<p>该函数允许通过格式化字符串和可变参数列表的方式往写缓冲区中添加HTTP响应内容，便于构建响应报文。</p>
<h3 id="状态行-add-status-line"><a href="#状态行-add-status-line" class="headerlink" title="状态行 add_status_line"></a>状态行 add_status_line</h3><p>这是<code>http_conn</code>类的成员函数<code>add_status_line</code>的实现，用于向写缓冲区中添加HTTP响应的状态行。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 状态行</span></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">http_conn::add_status_line</span><span class="params">(<span class="type">int</span> status, <span class="type">const</span> <span class="type">char</span> *title)</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">add_response</span>(<span class="string">&quot;%s %d %s\r\n&quot;</span>, <span class="string">&quot;HTTP/1.1&quot;</span>, status, title);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li><code>add_response(&quot;%s %d %s\r\n&quot;, &quot;HTTP/1.1&quot;, status, title)</code>：通过调用<code>add_response</code>函数，使用格式化字符串往写缓冲区中添加状态行内容。<code>&quot;%s %d %s\r\n&quot;</code>是格式化字符串，其中：<ul>
<li><code>%s</code> 会被替换为 “HTTP&#x2F;1.1”</li>
<li><code>%d</code> 会被替换为 <code>status</code> 参数传递的状态码</li>
<li><code>%s</code> 会被替换为 <code>title</code> 参数传递的状态码对应的文本描述</li>
<li><code>\r\n</code> 表示回车和换行，标识行结束</li>
</ul>
</li>
<li>返回<code>add_response</code>的执行结果。如果写缓冲区已满或其他写入错误，可能返回<code>false</code>。</li>
</ol>
<p>该函数主要用于构建HTTP响应的状态行，指定协议版本、状态码和状态码的文本描述。</p>
<h3 id="响应报头-add-headers"><a href="#响应报头-add-headers" class="headerlink" title="响应报头 add_headers"></a>响应报头 add_headers</h3><p>这是<code>http_conn</code>类的成员函数<code>add_headers</code>的实现，用于向写缓冲区中添加HTTP响应的报头。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 响应报头</span></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">http_conn::add_headers</span><span class="params">(<span class="type">int</span> content_len)</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">add_content_length</span>(content_len) &amp;&amp; <span class="built_in">add_linger</span>() &amp;&amp;</span><br><span class="line">           <span class="built_in">add_blank_line</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li><code>add_content_length(content_len)</code>：通过调用<code>add_content_length</code>函数，向写缓冲区中添加”Content-Length”字段，表示消息体的长度。<code>content_len</code>是传递的消息体长度。</li>
<li><code>add_linger()</code>：通过调用<code>add_linger</code>函数，向写缓冲区中添加”Connection”字段，表示是否使用持久连接。该函数会根据成员变量<code>m_linger</code>的值来确定是”keep-alive”还是”close”。</li>
<li><code>add_blank_line()</code>：通过调用<code>add_blank_line</code>函数，向写缓冲区中添加一个空行，用于分隔报头和消息体。</li>
<li>返回上述三个函数的执行结果的逻辑与(<code>&amp;&amp;</code>)运算结果。如果有任何一个函数返回<code>false</code>，整体结果也为<code>false</code>。</li>
</ol>
<p>该函数主要用于构建HTTP响应的报头，包括”Content-Length”字段、”Connection”字段以及一个空行。</p>
<h3 id="消息报头-add-content-length"><a href="#消息报头-add-content-length" class="headerlink" title="消息报头 add_content_length"></a>消息报头 add_content_length</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 消息报头</span></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">http_conn::add_content_length</span><span class="params">(<span class="type">int</span> content_len)</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">add_response</span>(<span class="string">&quot;Content-Length:%d\r\n&quot;</span>, content_len);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这是<code>http_conn</code>类的成员函数<code>add_content_length</code>的实现，用于向写缓冲区中添加HTTP响应的”Content-Length”字段。以下是该函数的解释：</p>
<ol>
<li><code>add_response(&quot;Content-Length:%d\r\n&quot;, content_len)</code>：通过调用<code>add_response</code>函数，向写缓冲区中添加”Content-Length”字段，指定消息体的长度为<code>content_len</code>。</li>
<li>返回上述函数的执行结果。</li>
</ol>
<p>该函数主要用于构建HTTP响应的报头中的”Content-Length”字段，指明消息体的长度。</p>
<h3 id="Content-Type-add-content-type"><a href="#Content-Type-add-content-type" class="headerlink" title="Content-Type add_content_type"></a>Content-Type add_content_type</h3><p>这是<code>http_conn</code>类的成员函数<code>add_content_type</code>的实现，用于向写缓冲区中添加HTTP响应的<code>Content-Type</code>字段。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">bool</span> <span class="title">http_conn::add_content_type</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">add_response</span>(<span class="string">&quot;Content-Type:%s\r\n&quot;</span>, <span class="string">&quot;text/html&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li><code>add_response(&quot;Content-Type:%s\r\n&quot;, &quot;text/html&quot;)</code>：通过调用<code>add_response</code>函数，向写缓冲区中添加”Content-Type”字段，指定消息体的类型为”text&#x2F;html”，表示HTML文档。</li>
<li>返回上述函数的执行结果。</li>
</ol>
<p>该函数主要用于构建HTTP响应的报头中的”Content-Type”字段，指明消息体的类型。在这里，它指定消息体的类型为HTML文档。</p>
<h3 id="add-linger"><a href="#add-linger" class="headerlink" title="add_linger"></a>add_linger</h3><p>这是<code>http_conn</code>类的成员函数<code>add_linger</code>的实现，用于向写缓冲区中添加HTTP响应的”Connection”字段。以下是该函数的解释：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">bool</span> <span class="title">http_conn::add_linger</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">add_response</span>(<span class="string">&quot;Connection:%s\r\n&quot;</span>, (m_linger == <span class="literal">true</span>) ? <span class="string">&quot;keep-alive&quot;</span> : <span class="string">&quot;close&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li><code>add_response(&quot;Connection:%s\r\n&quot;, (m_linger == true) ? &quot;keep-alive&quot; : &quot;close&quot;)</code>：通过调用<code>add_response</code>函数，向写缓冲区中添加”Connection”字段。如果<code>m_linger</code>成员变量为<code>true</code>，表示使用长连接，将”keep-alive”添加到字段中；否则，表示使用短连接，将”close”添加到字段中。</li>
<li>返回上述函数的执行结果。</li>
</ol>
<p>该函数主要用于构建HTTP响应的报头中的”Connection”字段，指明连接的持久性。如果<code>m_linger</code>为<code>true</code>，则使用长连接；否则，使用短连接。</p>
<h3 id="空行-add-blank-line"><a href="#空行-add-blank-line" class="headerlink" title="空行 add_blank_line"></a>空行 add_blank_line</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 空行</span></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">http_conn::add_blank_line</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">add_response</span>(<span class="string">&quot;%s&quot;</span>, <span class="string">&quot;\r\n&quot;</span>);</span><br><span class="line">&#125;这是`http_conn`类的成员函数`add_blank_line`的实现，用于向写缓冲区中添加一个空行，即`\r\n`，表示HTTP响应头部的结束。以下是该函数的解释：</span><br></pre></td></tr></table></figure>

<ol>
<li><code>add_response(&quot;%s&quot;, &quot;\r\n&quot;)</code>：通过调用<code>add_response</code>函数，向写缓冲区中添加一个空行。</li>
<li>返回上述函数的执行结果。</li>
</ol>
<p>该函数主要用于构建HTTP响应头的结束标志，以便与响应的实体主体（如果有的话）分隔开来。</p>
<h3 id="响应正文-add-content"><a href="#响应正文-add-content" class="headerlink" title="响应正文 add_content"></a>响应正文 add_content</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 响应正文</span></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">http_conn::add_content</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *content)</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">add_response</span>(<span class="string">&quot;%s&quot;</span>, content);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这是<code>http_conn</code>类的成员函数<code>add_content</code>的实现，用于向写缓冲区中添加HTTP响应正文内容。以下是该函数的解释：</p>
<ol>
<li><code>add_response(&quot;%s&quot;, content)</code>：通过调用<code>add_response</code>函数，向写缓冲区中添加传入的<code>content</code>参数，即HTTP响应的实体主体内容。</li>
<li>返回上述函数的执行结果。</li>
</ol>
<p>该函数主要用于向HTTP响应中添加实体主体的内容，例如 HTML 内容、图片、视频等。</p>
<h3 id="向缓冲区写响应-process-write"><a href="#向缓冲区写响应-process-write" class="headerlink" title="向缓冲区写响应 process_write"></a>向缓冲区写响应 process_write</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 向缓冲区写响应</span></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">http_conn::process_write</span><span class="params">(HTTP_CODE ret)</span></span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (ret)&#123;</span><br><span class="line">        <span class="keyword">case</span> INTERNAL_ERROR:&#123;</span><br><span class="line">            <span class="built_in">add_status_line</span>(<span class="number">500</span>, error_500_title);</span><br><span class="line">            <span class="built_in">add_headers</span>(<span class="built_in">strlen</span>(error_500_form));</span><br><span class="line">            <span class="keyword">if</span>(!<span class="built_in">add_content</span>(error_500_form))</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> BAD_REQUEST:&#123;</span><br><span class="line">            <span class="built_in">add_status_line</span>(<span class="number">404</span>, error_404_title);</span><br><span class="line">            <span class="built_in">add_headers</span>(<span class="built_in">strlen</span>(error_404_form));</span><br><span class="line">            <span class="keyword">if</span>(!<span class="built_in">add_content</span>(error_404_form))</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> FORBIDDEN_REQUEST:&#123;</span><br><span class="line">            <span class="built_in">add_status_line</span>(<span class="number">403</span>, error_403_title);</span><br><span class="line">            <span class="built_in">add_headers</span>(<span class="built_in">strlen</span>(error_403_form));</span><br><span class="line">            <span class="keyword">if</span>(!<span class="built_in">add_content</span>(error_403_form))</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> FILE_REQUEST:&#123;</span><br><span class="line">            <span class="built_in">add_status_line</span>(<span class="number">200</span>, ok_200_title);</span><br><span class="line">            <span class="keyword">if</span>(m_file_stat.st_size != <span class="number">0</span>)&#123;</span><br><span class="line">                <span class="built_in">add_headers</span>(m_file_stat.st_size);</span><br><span class="line">                <span class="comment">// 第一个元素指向响应报文写缓冲</span></span><br><span class="line">                m_iv[<span class="number">0</span>].iov_base = m_write_buf;</span><br><span class="line">                m_iv[<span class="number">0</span>].iov_len = m_write_idx;</span><br><span class="line">                <span class="comment">// 第二个元素指向mmap返回的文件指针</span></span><br><span class="line">                m_iv[<span class="number">1</span>].iov_base = m_file_address;</span><br><span class="line">                m_iv[<span class="number">1</span>].iov_len = m_file_stat.st_size;</span><br><span class="line">                m_iv_count = <span class="number">2</span>;</span><br><span class="line">                bytes_to_send = m_write_idx + m_file_stat.st_size;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 资源大小为0则返回空白html</span></span><br><span class="line">            <span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="type">const</span> <span class="type">char</span> *ok_string = <span class="string">&quot;&lt;html&gt;&lt;body&gt;&lt;/body&gt;&lt;/html&gt;&quot;</span>;</span><br><span class="line">                <span class="built_in">add_headers</span>(<span class="built_in">strlen</span>(ok_string));</span><br><span class="line">                <span class="keyword">if</span>(!<span class="built_in">add_content</span>(ok_string))</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 除FILE_REQUEST外只指向响应报文缓冲</span></span><br><span class="line">    m_iv[<span class="number">0</span>].iov_base = m_write_buf;</span><br><span class="line">    m_iv[<span class="number">0</span>].iov_len = m_write_idx;</span><br><span class="line">    m_iv_count = <span class="number">1</span>;</span><br><span class="line">    bytes_to_send = m_write_idx;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>process_write</code> 函数主要用于根据不同的 <code>HTTP_CODE</code> 处理响应。具体来说，根据传入的 <code>HTTP_CODE</code>，生成相应的 HTTP 响应报文。以下是对每个情况的解释：</p>
<ol>
<li><code>INTERNAL_ERROR</code>：生成 500 Internal Server Error 错误响应。设置状态行、响应头、实体主体，并将相关信息写入缓冲区。</li>
<li><code>BAD_REQUEST</code>：生成 404 Not Found 错误响应。设置状态行、响应头、实体主体，并将相关信息写入缓冲区。</li>
<li><code>FORBIDDEN_REQUEST</code>：生成 403 Forbidden 错误响应。设置状态行、响应头、实体主体，并将相关信息写入缓冲区。</li>
<li><code>FILE_REQUEST</code>：处理正常的文件请求。设置状态行、响应头，并将文件内容映射到写缓冲区中。这里使用 <code>writev</code> 函数进行数据的直接写入。</li>
<li>其他情况：返回 <code>false</code>。</li>
</ol>
<p>最后，根据生成的响应，设置写缓冲区的数据，并准备发送给客户端。</p>
<h3 id="http处理-process"><a href="#http处理-process" class="headerlink" title="http处理 process"></a>http处理 process</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// http处理</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">http_conn::process</span><span class="params">()</span></span>&#123;</span><br><span class="line">    HTTP_CODE read_ret = <span class="built_in">process_read</span>();</span><br><span class="line">    <span class="comment">// 请求不完整，继续注册读事件</span></span><br><span class="line">    <span class="keyword">if</span>(read_ret == NO_REQUEST)&#123;</span><br><span class="line">        <span class="built_in">modfd</span>(m_epollfd, m_sockfd, EPOLLIN, m_TRIGMode);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">bool</span> write_ret = <span class="built_in">process_write</span>(read_ret);</span><br><span class="line">    <span class="keyword">if</span>(!write_ret)&#123;</span><br><span class="line">        <span class="built_in">close_conn</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 准备好写缓冲，加入监听可写事件</span></span><br><span class="line">    <span class="built_in">modfd</span>(m_epollfd, m_sockfd, EPOLLOUT, m_TRIGMode);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>process</code> 函数用于处理 HTTP 请求。首先调用 <code>process_read</code> 函数进行请求的解析，根据返回的 <code>HTTP_CODE</code> 判断请求是否完整。如果请求不完整，则继续注册监听读事件。</p>
<p>如果请求完整，接着调用 <code>process_write</code> 函数生成相应的响应。如果 <code>process_write</code> 返回 <code>false</code>，则关闭连接。否则，准备好写缓冲，加入监听可写事件。</p>
<p>这个函数的逻辑是基于事件驱动的异步非阻塞模型，通过监听和处理事件来实现高并发。</p>

                </div>

                
                        
<div class="post-copyright-info-container border-box">
    <div class="copyright-info-content border-box">
        <div class="copyright-info-top border-box">
            <div class="copyright-post-title border-box text-ellipsis">
                从零实现WebServer之HTTP请求类
            </div>

            <div class="copyright-post-link border-box text-ellipsis">
                2024/01/05/从零实现WebServer之HTTP请求类/
            </div>
        </div>

        <div class="copyright-info-bottom border-box">
            <div class="copyright-post-author bottom-item">
                <div class="type">
                    作者
                </div>
                <div class="content">Mzy</div>
            </div>

            <div class="post-time bottom-item">
                <div class="type">
                    发布于
                </div>
                <div class="content">2024-01-05 13:55</div>
            </div>


            <div class="post-license bottom-item">
                <div class="type">
                    许可
                </div>
                <div class="content tooltip" data-tooltip-content="CC BY-NC-SA 4.0">
                    <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh-hans">
                        <i class="fa-brands fa-creative-commons"></i>
                        <i class="fa-brands fa-creative-commons-by"></i>
                        <i class="fa-brands fa-creative-commons-nc"></i>
                        <i class="fa-brands fa-creative-commons-sa"></i>
                    </a>
                </div>
            </div>
        </div>

        <i class="copyright-bg fa-solid fa-copyright"></i>
    </div>
    <div class="copy-copyright-info flex-center tooltip" data-tooltip-content="复制版权信息" data-tooltip-offset-y="-2px">
        <i class="fa-solid fa-copy"></i>
    </div>
</div>

                

                <div class="post-bottom-tags-and-share border-box">
                    <div>
                        
                            <ul class="post-tags-box border-box">
                                
                                    <li class="tag-item border-box">
                                        <i class="icon fas fa-hashtag"></i>&nbsp;<a href="/tags/c/">c++</a>
                                    </li>
                                
                                    <li class="tag-item border-box">
                                        <i class="icon fas fa-hashtag"></i>&nbsp;<a href="/tags/WebServer/">WebServer</a>
                                    </li>
                                
                            </ul>
                        
                    </div>
                    <div>
                        
                            <div class="post-share-container border-box">
    <ul class="share-list-wrap border-box">
        <li class="qq share-item border-box flex-center tooltip"
            data-tooltip-content="分享到 QQ"
        >
            <i class="fa-brands fa-qq"></i>
        </li>
        <li class="wechat share-item border-box flex-center tooltip tooltip-img"
            data-tooltip-content="分享到微信"
            data-tooltip-img-tip="微信扫一扫"
            data-tooltip-img-style="background-color: #fff; top: -10px; padding: 0.6rem 0.6rem 0.1rem 0.6rem;"
        >
            <i class="fa-brands fa-weixin"></i>
        </li>
        <li class="weibo share-item border-box flex-center tooltip"
            data-tooltip-content="分享到微博"
        >
            <i class="fa-brands fa-weibo"></i>
        </li>
    </ul>
</div>

                        
                    </div>
                </div>

                

                
                    <div class="post-nav border-box">
                        
                            <div class="prev-post">
                                <a class="prev"
                                   rel="prev"
                                   href="/2024/01/08/%E4%BB%8E%E9%9B%B6%E5%AE%9E%E7%8E%B0WebServer%E4%B9%8BServer%E7%B1%BB/"
                                   title="从零实现WebServer之Server类"
                                >
                                    <span class="left arrow-icon flex-center">
                                        <i class="fas fa-chevron-left"></i>
                                    </span>
                                    <span class="title flex-center">
                                        <span class="post-nav-title-item text-ellipsis">从零实现WebServer之Server类</span>
                                        <span class="post-nav-item">上一篇</span>
                                    </span>
                                </a>
                            </div>
                        
                        
                            <div class="next-post">
                                <a class="next"
                                   rel="next"
                                   href="/2024/01/04/%E5%AE%9A%E6%97%B6%E5%99%A8%E4%B9%8B%E6%97%B6%E9%97%B4%E5%A0%86/"
                                   title="定时器之时间堆"
                                >
                                    <span class="title flex-center">
                                        <span class="post-nav-title-item text-ellipsis">定时器之时间堆</span>
                                        <span class="post-nav-item">下一篇</span>
                                    </span>
                                    <span class="right arrow-icon flex-center">
                                        <i class="fas fa-chevron-right"></i>
                                    </span>
                                </a>
                            </div>
                        
                    </div>
                

                
                    


    <div class="comments-container border-box">
        <div id="comments-anchor" class="comment-area-title border-box">
            <i class="fas fa-comments"></i>&nbsp;评论
        </div>
        <div class="comment-plugin-fail border-box">
    <span class="fail-tip">评论插件加载失败</span>
    <button class="reload keep-button">点击重新加载</button>
</div>
<div class="comment-plugin-loading flex-center border-box">
    <i class="loading-icon fa-solid fa-spinner fa-spin"></i>
    <span class="load-tip">正在加载评论插件</span>
</div>
<script data-pjax>
  window.KeepCommentPlugin = {}
  window.KeepCommentPlugin.hideLoading = () => {
    const cplDom = document.querySelector('.comments-container .comment-plugin-loading')
    cplDom.style.display = 'none'
  }
  window.KeepCommentPlugin.loadFailHandle = () => {
    window.KeepCommentPlugin.hideLoading()
    const cpfDom = document.querySelector('.comments-container .comment-plugin-fail')
    cpfDom.style.display = 'flex'
    cpfDom.querySelector('.reload').addEventListener('click', () => {
      window.location.reload()
    })
  }
</script>

        
            

    <div class="waline-comment-container">
        <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/@waline/client@v2/dist/waline.css"/>
        <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/@waline/client@v2/dist/waline-meta.css"/>
        <div id="waline-comment"></div>
        <script data-pjax
                src="//cdn.jsdelivr.net/npm/@waline/client@v2/dist/waline.js"
                async
                onerror="window.KeepCommentPlugin.loadFailHandle()"
        ></script>
        <script data-pjax
                async
        >
          window.KeepCommentPlugin.walineOptions = JSON.parse('{}'.replace(/&#34;/g, '"'))

          window.KeepCommentPlugin.initWaline = () => {
            if (window?.Waline) {
              window.KeepCommentPlugin.walineOptions.el = '#waline-comment'
              window.KeepCommentPlugin.walineOptions.comment = '.post-comments-count'
              window.KeepCommentPlugin.walineOptions.serverURL = 'https://waline-test-liart.vercel.app'
              window.KeepCommentPlugin.walineOptions.lang = 'zh-CN' || 'zh-CN'
              window.KeepCommentPlugin.walineOptions.reaction = 'true' === 'true'
              window.Waline.init(window.KeepCommentPlugin.walineOptions)
              window.KeepCommentPlugin.hideLoading()
            } else {
              setTimeout(() => {
                window.KeepCommentPlugin.initWaline()
              }, 1000)
            }
          }

          if ('true' === 'true') {
            setTimeout(() => {
              window.KeepCommentPlugin.initWaline()
            }, 1200)
          } else {
            window.addEventListener('DOMContentLoaded', window.KeepCommentPlugin.initWaline)
          }
        </script>
    </div>


        
    </div>





                
            </div>
        </div>

        
            <div class="pc-post-toc right-toc">
                <div class="post-toc-wrap border-box">
    <div class="post-toc border-box">
        <ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BB%8E%E9%9B%B6%E5%AE%9E%E7%8E%B0WebServer%E4%B9%8BHTTP%E8%AF%B7%E6%B1%82%E7%B1%BB"><span class="nav-number">1.</span> <span class="nav-text">从零实现WebServer之HTTP请求类</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#http%E8%AF%B7%E6%B1%82%E7%B1%BB"><span class="nav-number">1.1.</span> <span class="nav-text">http请求类</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96%E7%94%A8%E6%88%B7%E8%A1%A8%E6%95%B0%E6%8D%AE-initmysql-result"><span class="nav-number">1.1.1.</span> <span class="nav-text">获取用户表数据 initmysql_result</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%AE%BE%E7%BD%AE%E9%9D%9E%E9%98%BB%E5%A1%9E-setnonblocking"><span class="nav-number">1.1.2.</span> <span class="nav-text">设置非阻塞 setnonblocking</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B3%A8%E5%86%8C%E8%AF%BB%E4%BA%8B%E4%BB%B6-addfd"><span class="nav-number">1.1.3.</span> <span class="nav-text">注册读事件 addfd</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%A0%E9%99%A4%E6%8F%8F%E8%BF%B0%E7%AC%A6-removefd"><span class="nav-number">1.1.4.</span> <span class="nav-text">删除描述符 removefd</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%87%8D%E7%BD%AE-modfd"><span class="nav-number">1.1.5.</span> <span class="nav-text">重置 modfd</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%B3%E9%97%AD%E4%B8%80%E4%B8%AA%E5%AE%A2%E6%88%B7%E8%BF%9E%E6%8E%A5-close-conn"><span class="nav-number">1.1.6.</span> <span class="nav-text">关闭一个客户连接 close_conn</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96%E6%96%B0%E6%8E%A5%E5%8F%97%E7%9A%84%E8%BF%9E%E6%8E%A5-init"><span class="nav-number">1.1.7.</span> <span class="nav-text">初始化新接受的连接 init</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96%E8%BF%9E%E6%8E%A5-init"><span class="nav-number">1.1.8.</span> <span class="nav-text">初始化连接 init</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%86%E6%9E%90%E4%B8%80%E8%A1%8C%E5%86%85%E5%AE%B9-parse-line"><span class="nav-number">1.1.9.</span> <span class="nav-text">分析一行内容 parse_line</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BE%AA%E7%8E%AF%E8%AF%BB%E5%8F%96%E5%AE%A2%E6%88%B7%E6%95%B0%E6%8D%AE-read-once"><span class="nav-number">1.1.10.</span> <span class="nav-text">循环读取客户数据 read_once</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%A7%A3%E6%9E%90HTTP%E8%AF%B7%E6%B1%82%E8%A1%8C-parse-request-line"><span class="nav-number">1.1.11.</span> <span class="nav-text">解析HTTP请求行 parse_request_line</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%A7%A3%E6%9E%90HTTP%E8%AF%B7%E6%B1%82%E5%A4%B4-parse-headers"><span class="nav-number">1.1.12.</span> <span class="nav-text">解析HTTP请求头 parse_headers</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%A4%E6%96%ADHTTP%E8%AF%B7%E6%B1%82%E6%98%AF%E5%90%A6%E8%A2%AB%E5%AE%8C%E5%85%A8%E8%AF%BB%E5%85%A5-parse-content"><span class="nav-number">1.1.13.</span> <span class="nav-text">判断HTTP请求是否被完全读入 parse_content</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A4%84%E7%90%86%E6%8E%A5%E6%94%B6%E5%88%B0%E7%9A%84HTTP%E8%AF%B7%E6%B1%82%E6%95%B0%E6%8D%AE-process-read"><span class="nav-number">1.1.14.</span> <span class="nav-text">处理接收到的HTTP请求数据 process_read</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%AF%B7%E6%B1%82%E5%AE%9E%E7%8E%B0-do-request"><span class="nav-number">1.1.15.</span> <span class="nav-text">请求实现 do_request</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%B3%E9%97%AD%E6%96%87%E4%BB%B6%E6%98%A0%E5%B0%84-unmap"><span class="nav-number">1.1.16.</span> <span class="nav-text">关闭文件映射 unmap</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%90%91%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%86%99%E5%93%8D%E5%BA%94-write"><span class="nav-number">1.1.17.</span> <span class="nav-text">向客户端写响应 write</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%8A%B6%E6%80%81%E8%A1%8C-add-status-line"><span class="nav-number">1.1.18.</span> <span class="nav-text">状态行 add_status_line</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%93%8D%E5%BA%94%E6%8A%A5%E5%A4%B4-add-headers"><span class="nav-number">1.1.19.</span> <span class="nav-text">响应报头 add_headers</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B6%88%E6%81%AF%E6%8A%A5%E5%A4%B4-add-content-length"><span class="nav-number">1.1.20.</span> <span class="nav-text">消息报头 add_content_length</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Content-Type-add-content-type"><span class="nav-number">1.1.21.</span> <span class="nav-text">Content-Type add_content_type</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#add-linger"><span class="nav-number">1.1.22.</span> <span class="nav-text">add_linger</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%A9%BA%E8%A1%8C-add-blank-line"><span class="nav-number">1.1.23.</span> <span class="nav-text">空行 add_blank_line</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%93%8D%E5%BA%94%E6%AD%A3%E6%96%87-add-content"><span class="nav-number">1.1.24.</span> <span class="nav-text">响应正文 add_content</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%90%91%E7%BC%93%E5%86%B2%E5%8C%BA%E5%86%99%E5%93%8D%E5%BA%94-process-write"><span class="nav-number">1.1.25.</span> <span class="nav-text">向缓冲区写响应 process_write</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#http%E5%A4%84%E7%90%86-process"><span class="nav-number">1.1.26.</span> <span class="nav-text">http处理 process</span></a></li></ol></li></ol></li></ol>
    </div>
</div>

            </div>
        
    </div>
</div>


                
            </div>

        </div>

        <div class="page-main-content-bottom border-box">
            
<footer class="footer border-box">
    <div class="border-box website-info-box default">
        
            <div class="copyright-info info-item default">
                &copy;&nbsp;<span>2022</span>&nbsp;-&nbsp;2024
                
                    &nbsp;<i class="fas fa-heart icon-animate"></i>&nbsp;&nbsp;<a href="/">Mzy</a>
                
            </div>

            <div class="theme-info info-item default">
                由&nbsp;<a target="_blank" href="https://hexo.io">Hexo</a>&nbsp;驱动&nbsp;&&nbsp;主题&nbsp;<a class="keep-version" target="_blank" href="https://github.com/XPoet/hexo-theme-keep">Keep</a>
            </div>

            

            
                
                <div class="deploy-info info-item default">
                    
                        本站由 <span class="tooltip" data-tooltip-content="GitHub Pages"><img src="/images/deploy-provider/github.png"></span> 提供部署服务
                    
                </div>
            
        

        <div class="count-item info-item default">
            
                <span class="count-box border-box word">
                    <span class="item-type border-box">总字数</span>
                    <span class="item-value border-box word">113.4k</span>
                </span>
            

            
                <span class="count-box border-box uv">
                    <span class="item-type border-box">访客数</span>
                    <span class="item-value border-box uv" id="busuanzi_value_site_uv"></span>
                </span>
            

            
        </div>
    </div>
</footer>

        </div>
    </div>

    <!-- post tools -->
    
        <div class="post-tools right-toc">
            <div class="post-tools-container border-box">
    <ul class="tools-list border-box">
        <!-- PC TOC show toggle -->
        
            <li class="tools-item flex-center toggle-show-toc">
                <i class="fas fa-list"></i>
            </li>
        

        <!-- PC go comment -->
        
            <li class="tools-item flex-center go-to-comments">
                <i class="fas fa-comment"></i>
                <span class="post-comments-count"></span>
            </li>
        
    </ul>
</div>

        </div>
    

    <!-- side tools -->
    <div class="side-tools">
        <div class="side-tools-container border-box ">
    <ul class="side-tools-list side-tools-show-handle border-box">
        <li class="tools-item tool-font-adjust-plus flex-center">
            <i class="fas fa-search-plus"></i>
        </li>

        <li class="tools-item tool-font-adjust-minus flex-center">
            <i class="fas fa-search-minus"></i>
        </li>

        <li class="tools-item tool-toggle-theme-mode flex-center">
            <i class="fas fa-moon"></i>
        </li>

        <!-- rss -->
        

        <li class="tools-item tool-scroll-to-bottom flex-center">
            <i class="fas fa-arrow-down"></i>
        </li>
    </ul>

    <ul class="exposed-tools-list border-box">
        
            <li class="tools-item toggle-show-toc-tablet flex-center">
                <i class="fas fa-list"></i>
            </li>
        

        
            <li class="tools-item go-to-comments-tablet flex-center">
                <i class="fas fa-comment"></i>
            </li>
        

        <li class="tools-item tool-toggle-show flex-center">
            <i class="fas fa-cog fa-spin"></i>
        </li>

        <li class="tools-item tool-scroll-to-top flex-center show-arrow">
            <i class="arrow fas fa-arrow-up"></i>
            <span class="percent"></span>
        </li>
    </ul>
</div>

    </div>

    <!-- image mask -->
    <div class="zoom-in-image-mask">
    <img class="zoom-in-image">
</div>


    <!-- local search -->
    
        <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
          <span class="search-input-field-pre">
            <i class="fas fa-keyboard"></i>
          </span>
            <div class="search-input-container">
                <input autocomplete="off"
                       autocorrect="off"
                       autocapitalize="off"
                       placeholder="搜索..."
                       spellcheck="false"
                       type="search"
                       class="search-input"
                >
            </div>
            <span class="close-popup-btn">
                <i class="fas fa-times"></i>
            </span>
        </div>
        <div id="search-result">
            <div id="no-result">
                <i class="fas fa-spinner fa-pulse fa-5x fa-fw"></i>
            </div>
        </div>
    </div>
</div>

    

    <!-- tablet toc -->
    
        <div class="tablet-post-toc-mask">
            <div class="tablet-post-toc">
                <div class="post-toc-wrap border-box">
    <div class="post-toc border-box">
        <ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BB%8E%E9%9B%B6%E5%AE%9E%E7%8E%B0WebServer%E4%B9%8BHTTP%E8%AF%B7%E6%B1%82%E7%B1%BB"><span class="nav-number">1.</span> <span class="nav-text">从零实现WebServer之HTTP请求类</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#http%E8%AF%B7%E6%B1%82%E7%B1%BB"><span class="nav-number">1.1.</span> <span class="nav-text">http请求类</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96%E7%94%A8%E6%88%B7%E8%A1%A8%E6%95%B0%E6%8D%AE-initmysql-result"><span class="nav-number">1.1.1.</span> <span class="nav-text">获取用户表数据 initmysql_result</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%AE%BE%E7%BD%AE%E9%9D%9E%E9%98%BB%E5%A1%9E-setnonblocking"><span class="nav-number">1.1.2.</span> <span class="nav-text">设置非阻塞 setnonblocking</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B3%A8%E5%86%8C%E8%AF%BB%E4%BA%8B%E4%BB%B6-addfd"><span class="nav-number">1.1.3.</span> <span class="nav-text">注册读事件 addfd</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%A0%E9%99%A4%E6%8F%8F%E8%BF%B0%E7%AC%A6-removefd"><span class="nav-number">1.1.4.</span> <span class="nav-text">删除描述符 removefd</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%87%8D%E7%BD%AE-modfd"><span class="nav-number">1.1.5.</span> <span class="nav-text">重置 modfd</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%B3%E9%97%AD%E4%B8%80%E4%B8%AA%E5%AE%A2%E6%88%B7%E8%BF%9E%E6%8E%A5-close-conn"><span class="nav-number">1.1.6.</span> <span class="nav-text">关闭一个客户连接 close_conn</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96%E6%96%B0%E6%8E%A5%E5%8F%97%E7%9A%84%E8%BF%9E%E6%8E%A5-init"><span class="nav-number">1.1.7.</span> <span class="nav-text">初始化新接受的连接 init</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96%E8%BF%9E%E6%8E%A5-init"><span class="nav-number">1.1.8.</span> <span class="nav-text">初始化连接 init</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%86%E6%9E%90%E4%B8%80%E8%A1%8C%E5%86%85%E5%AE%B9-parse-line"><span class="nav-number">1.1.9.</span> <span class="nav-text">分析一行内容 parse_line</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BE%AA%E7%8E%AF%E8%AF%BB%E5%8F%96%E5%AE%A2%E6%88%B7%E6%95%B0%E6%8D%AE-read-once"><span class="nav-number">1.1.10.</span> <span class="nav-text">循环读取客户数据 read_once</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%A7%A3%E6%9E%90HTTP%E8%AF%B7%E6%B1%82%E8%A1%8C-parse-request-line"><span class="nav-number">1.1.11.</span> <span class="nav-text">解析HTTP请求行 parse_request_line</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%A7%A3%E6%9E%90HTTP%E8%AF%B7%E6%B1%82%E5%A4%B4-parse-headers"><span class="nav-number">1.1.12.</span> <span class="nav-text">解析HTTP请求头 parse_headers</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%A4%E6%96%ADHTTP%E8%AF%B7%E6%B1%82%E6%98%AF%E5%90%A6%E8%A2%AB%E5%AE%8C%E5%85%A8%E8%AF%BB%E5%85%A5-parse-content"><span class="nav-number">1.1.13.</span> <span class="nav-text">判断HTTP请求是否被完全读入 parse_content</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A4%84%E7%90%86%E6%8E%A5%E6%94%B6%E5%88%B0%E7%9A%84HTTP%E8%AF%B7%E6%B1%82%E6%95%B0%E6%8D%AE-process-read"><span class="nav-number">1.1.14.</span> <span class="nav-text">处理接收到的HTTP请求数据 process_read</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%AF%B7%E6%B1%82%E5%AE%9E%E7%8E%B0-do-request"><span class="nav-number">1.1.15.</span> <span class="nav-text">请求实现 do_request</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%B3%E9%97%AD%E6%96%87%E4%BB%B6%E6%98%A0%E5%B0%84-unmap"><span class="nav-number">1.1.16.</span> <span class="nav-text">关闭文件映射 unmap</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%90%91%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%86%99%E5%93%8D%E5%BA%94-write"><span class="nav-number">1.1.17.</span> <span class="nav-text">向客户端写响应 write</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%8A%B6%E6%80%81%E8%A1%8C-add-status-line"><span class="nav-number">1.1.18.</span> <span class="nav-text">状态行 add_status_line</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%93%8D%E5%BA%94%E6%8A%A5%E5%A4%B4-add-headers"><span class="nav-number">1.1.19.</span> <span class="nav-text">响应报头 add_headers</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B6%88%E6%81%AF%E6%8A%A5%E5%A4%B4-add-content-length"><span class="nav-number">1.1.20.</span> <span class="nav-text">消息报头 add_content_length</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Content-Type-add-content-type"><span class="nav-number">1.1.21.</span> <span class="nav-text">Content-Type add_content_type</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#add-linger"><span class="nav-number">1.1.22.</span> <span class="nav-text">add_linger</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%A9%BA%E8%A1%8C-add-blank-line"><span class="nav-number">1.1.23.</span> <span class="nav-text">空行 add_blank_line</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%93%8D%E5%BA%94%E6%AD%A3%E6%96%87-add-content"><span class="nav-number">1.1.24.</span> <span class="nav-text">响应正文 add_content</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%90%91%E7%BC%93%E5%86%B2%E5%8C%BA%E5%86%99%E5%93%8D%E5%BA%94-process-write"><span class="nav-number">1.1.25.</span> <span class="nav-text">向缓冲区写响应 process_write</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#http%E5%A4%84%E7%90%86-process"><span class="nav-number">1.1.26.</span> <span class="nav-text">http处理 process</span></a></li></ol></li></ol></li></ol>
    </div>
</div>

            </div>
        </div>
    
</main>



<!-- common -->
<script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@4.0.5/source/js/utils.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@4.0.5/source/js/header-shrink.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@4.0.5/source/js/back2top.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@4.0.5/source/js/toggle-theme.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@4.0.5/source/js/code-block.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@4.0.5/source/js/main.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@4.0.5/source/js/libs/anime.min.js"></script>

<!-- local-search -->

    <script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@4.0.5/source/js/local-search.js"></script>


<!-- lazyload -->


<div class="pjax">
    
        <!-- post-helper -->
        <script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@4.0.5/source/js/post/post-helper.js"></script>

        <!-- toc -->
        
            <script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@4.0.5/source/js/post/toc.js"></script>
        

        <!-- copyright-info -->
        
            <script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@4.0.5/source/js/post/copyright-info.js"></script>
        

        <!-- share -->
        
            <script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@4.0.5/source/js/post/share.js"></script>
        
    

    <!-- category-page -->
    

    <!-- links-page -->
    

    <!-- photos-page -->
    
</div>

<!-- mermaid -->


<!-- pjax -->

    <script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@4.0.5/source/js/libs/pjax.min.js"></script>
<script>
    window.addEventListener('DOMContentLoaded', () => {
        window.pjax = new Pjax({
            selectors: [
                'head title',
                '.page-container',
                '.pjax'
            ],
            history: true,
            debug: false,
            cacheBust: false,
            timeout: 0,
            analytics: false,
            currentUrlFullReload: false,
            scrollRestoration: false,
        });

        document.addEventListener('pjax:send', () => {
            KEEP.utils.pjaxProgressBarStart()
        });

        document.addEventListener('pjax:complete', () => {
            KEEP.utils.pjaxProgressBarEnd()
            window.pjax.executeScripts(document.querySelectorAll('script[data-pjax], .pjax script'))
            KEEP.initExecute()
        });
    });
</script>




</body>
</html>
